<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Tập Ghi Nhớ Từ Vựng với AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            width: 100%;
        }
        .screen-wrapper {
             position: relative;
             min-height: 500px;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        .feedback-correct {
            animation: flash-green 0.8s;
        }
        .feedback-incorrect {
            animation: flash-red 0.8s;
        }
        @keyframes flash-green {
            0%, 100% { background-color: #fff; }
            50% { background-color: #f0fdf4; }
        }
        @keyframes flash-red {
            0%, 100% { background-color: #fff; }
            50% { background-color: #fef2f2; }
        }
        #answer-display, #gemini-features-container {
            transition: all 0.3s ease-in-out;
        }
        .topic-button {
            transition: all 0.2s ease-in-out;
        }
        .topic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #6366f1;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #a5b4fc;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .mic-listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto screen-wrapper">
        <!-- Section 1: Upload -->
        <div id="upload-section" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl shadow-slate-300/60 text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 mb-6">
                    <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Bắt đầu Luyện tập</h1>
                <p class="text-slate-600 mb-6">Tải lên file từ vựng của bạn, hoặc để AI tạo giúp bạn.</p>
                <div class="space-y-4">
                    <label for="file-input" class="w-full inline-block bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-300 cursor-pointer shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50">
                        Chọn File Excel
                    </label>
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    
                    <button id="generate-vocab-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition-all duration-300 cursor-pointer shadow-lg shadow-teal-500/30 hover:shadow-teal-500/50 flex items-center justify-center gap-2">
                        ✨ Tạo bộ từ vựng bằng AI
                    </button>
                </div>
                <p id="file-name-display" class="text-sm text-slate-500 mt-4 h-5"></p>
                <p id="upload-error" class="text-sm text-red-500 mt-1 h-5"></p>
            </div>
        </div>
        
        <!-- Section 2: Topic Selection -->
        <div id="topic-section" class="screen hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <header class="text-center mb-6">
                    <h1 id="selection-header" class="text-2xl font-bold text-slate-800">Chọn Chủ Đề</h1>
                    <p id="selection-subheader" class="text-slate-500">Tập trung vào một chủ đề để học hiệu quả hơn.</p>
                </header>
                 <div id="special-selection-list" class="space-y-3 mb-6">
                    <!-- Review and All buttons will be inserted here -->
                </div>
                <div id="selection-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[28rem] overflow-y-auto p-1">
                    <!-- Topic/Pack buttons will be inserted here -->
                </div>
                 <button id="back-to-upload-btn" class="mt-6 w-full text-center text-sm text-slate-500 hover:text-indigo-600 font-medium">Quay lại</button>
            </div>
        </div>

        <!-- Section 3: Main App -->
        <div id="app-container" class="screen hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <header class="text-center mb-4 relative">
                    <button id="back-to-selection-btn" class="absolute left-0 top-1 text-slate-500 hover:text-indigo-600 transition-colors" title="Quay lại chọn chủ đề/gói">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <h1 id="app-title" class="text-2xl font-bold text-slate-800">Topic: </h1>
                    <p id="instruction-text" class="text-slate-500">Nhập nghĩa tương ứng của từ bên dưới.</p>
                </header>

                <main>
                    <div id="pack-selector-container" class="hidden mb-4 text-center">
                        <label for="pack-selector" class="text-sm font-medium text-slate-600 mr-2">Chuyển gói:</label>
                        <select id="pack-selector" class="rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm py-1"></select>
                    </div>

                    <div class="mb-6">
                        <div class="flex flex-wrap items-center justify-center gap-x-6 gap-y-3" id="mode-selector">
                             <div>
                                <input type="radio" id="mode-vi-en" name="game-mode" value="vi-en" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="mode-vi-en" class="ml-2 text-slate-700 cursor-pointer">Việt → Anh</label>
                            </div>
                            <div id="ipa-mode-container" class="hidden">
                                <input type="radio" id="mode-ipa" name="game-mode" value="ipa" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="mode-ipa" class="ml-2 text-slate-700 cursor-pointer">IPA → Anh</label>
                            </div>
                            <div>
                                <input type="radio" id="mode-en-vi" name="game-mode" value="en-vi" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="mode-en-vi" class="ml-2 text-slate-700 cursor-pointer">Anh → Việt</label>
                            </div>
                            <div id="speak-mode-container" class="hidden">
                                <input type="radio" id="mode-speak" name="game-mode" value="speak" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="mode-speak" class="ml-2 text-slate-700 cursor-pointer">Luyện nói (Anh)</label>
                            </div>
                        </div>
                    </div>

                    <div id="card-display" class="relative w-full min-h-[10rem] bg-slate-50 border border-slate-200 rounded-xl flex flex-col justify-center items-center p-4 mb-6 text-center">
                        <span id="word-topic" class="absolute top-2.5 right-3 text-xs bg-slate-200 text-slate-600 font-medium px-2 py-1 rounded-full"></span>
                        <div class="flex items-center gap-2">
                            <h2 id="word-display" class="text-3xl md:text-4xl font-bold text-indigo-600 px-2"></h2>
                            <button id="main-speaker-btn" class="hidden text-slate-400 hover:text-indigo-600 transition-colors">
                                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                            </button>
                        </div>
                        <p id="word-ipa" class="text-xl text-slate-500 mt-2"></p>
                    </div>

                    <div class="space-y-4">
                        <div id="input-container" class="relative">
                            <button id="speak-btn" class="hidden absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 p-1 rounded-full">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" /><path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.75 6.75 0 11-13.5 0v-1.5A.75.75 0 016 10.5z" /></svg>
                            </button>
                            <input type="text" id="answer-input" placeholder="Gõ câu trả lời ở đây..." class="w-full px-4 py-3.5 text-lg border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
                            <div id="feedback-icon" class="absolute right-4 top-1/2 -translate-y-1/2"></div>
                        </div>
                        
                        <div id="answer-display" class="hidden opacity-0 p-4 rounded-lg">
                             <div class="flex items-center justify-between">
                                <p class="answer-title text-sm font-semibold"></p>
                                <button id="answer-speaker-btn" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                </button>
                            </div>
                             <p class="answer-word text-lg font-bold" id="correct-word"></p>
                             <p class="answer-ipa text-md" id="correct-ipa"></p>
                             <p class="answer-meaning text-md font-semibold mt-1" id="correct-meaning"></p>
                             
                             <!-- Example Container -->
                             <div id="example-container" class="mt-3 pt-3 border-t border-slate-200/80">
                                 <div id="example-loader" class="hidden items-center">
                                     <div class="loader !w-4 !h-4 !border-teal-500 !border-b-transparent"></div>
                                     <span class="text-xs text-slate-500 ml-2">AI đang tạo ví dụ...</span>
                                 </div>
                                 <div id="example-content" class="text-sm space-y-3">
                                     <!-- IELTS Example -->
                                     <div id="ielts-example-container" class="hidden">
                                        <div class="flex items-center justify-between">
                                             <p class="font-semibold text-slate-700">Ví dụ (IELTS):</p>
                                             <button id="ielts-example-speaker-btn" title="Đọc câu ví dụ IELTS" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                             </button>
                                         </div>
                                         <p id="ielts-example-sentence" class="text-slate-800"></p>
                                         <p id="ielts-example-sentence-vi" class="text-slate-600"></p>
                                     </div>
                                     <!-- Communication Example -->
                                     <div id="comm-example-container" class="hidden">
                                        <div class="flex items-center justify-between">
                                             <p class="font-semibold text-slate-700">Ví dụ (Giao tiếp):</p>
                                              <button id="comm-example-speaker-btn" title="Đọc câu ví dụ Giao tiếp" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                             </button>
                                         </div>
                                         <p id="comm-example-sentence" class="text-slate-800"></p>
                                         <p id="comm-example-sentence-vi" class="text-slate-600"></p>
                                     </div>
                                      <!-- Single pre-existing example -->
                                     <div id="single-example-container" class="hidden">
                                         <div class="flex items-center justify-between">
                                              <p class="font-semibold text-slate-700">Ví dụ:</p>
                                              <button id="single-example-speaker-btn" title="Đọc câu ví dụ" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                             </button>
                                         </div>
                                         <p id="example-sentence" class="text-slate-800"></p>
                                         <p id="example-sentence-vi" class="text-slate-600"></p>
                                     </div>
                                     <p id="example-error" class="text-xs text-red-500"></p>
                                 </div>
                             </div>

                             <!-- Gemini Features Container -->
                             <div id="gemini-features-container" class="mt-3 pt-3 border-t border-slate-200/80">
                                 <button id="generate-example-btn" class="text-sm font-medium text-teal-600 hover:text-teal-700 flex items-center gap-1.5">
                                    <span id="gemini-btn-loader" class="hidden"><span class="loader !w-4 !h-4"></span></span>
                                    <span id="gemini-btn-text">✨ Tạo ví dụ khác</span>
                                 </button>
                             </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button id="check-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Kiểm Tra</button>
                            <button id="next-btn" class="w-full bg-slate-700 text-white font-semibold py-3 rounded-lg hover:bg-slate-800 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Từ Tiếp Theo</button>
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                        <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="text-slate-600">Tiến độ</span>
                            <span class="font-medium text-slate-700"><span id="learned-count">0</span> / <span id="total-count">0</span></span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modal for general messages and Gemini topic input -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="modal-message" class="text-slate-600 mb-4"></p>
            <div id="modal-input-container" class="hidden mb-4">
                 <input type="text" id="modal-input" placeholder="Nhập chủ đề ở đây..." class="w-full px-3 py-2 text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="modal-loader" class="hidden my-4 flex justify-center"><div class="loader"></div></div>
            <div id="modal-buttons">
                <button id="modal-confirm-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors w-full">Xác nhận</button>
                <button id="modal-cancel-btn" class="mt-2 text-sm text-slate-600 hover:bg-slate-100 py-2 px-4 rounded-lg">Hủy</button>
            </div>
        </div>
    </div>
    
    <script>
        /**
         * -------------------
         * UI MODULE
         * Handles all direct DOM manipulations and UI updates.
         * -------------------
         */
        const UIModule = (() => {
            const DOMElements = {
                // Screens
                uploadSection: document.getElementById('upload-section'),
                topicSection: document.getElementById('topic-section'),
                appContainer: document.getElementById('app-container'),
                // Upload
                fileInput: document.getElementById('file-input'),
                fileNameDisplay: document.getElementById('file-name-display'),
                uploadError: document.getElementById('upload-error'),
                generateVocabBtn: document.getElementById('generate-vocab-btn'),
                // Topic Selection
                selectionHeader: document.getElementById('selection-header'),
                selectionSubheader: document.getElementById('selection-subheader'),
                specialSelectionListContainer: document.getElementById('special-selection-list'),
                selectionListContainer: document.getElementById('selection-list'),
                backToUploadBtn: document.getElementById('back-to-upload-btn'),
                // App
                appTitle: document.getElementById('app-title'),
                backToSelectionBtn: document.getElementById('back-to-selection-btn'),
                packSelectorContainer: document.getElementById('pack-selector-container'),
                packSelector: document.getElementById('pack-selector'),
                instructionText: document.getElementById('instruction-text'),
                modeSelector: document.getElementById('mode-selector'),
                ipaModeContainer: document.getElementById('ipa-mode-container'),
                speakModeContainer: document.getElementById('speak-mode-container'),
                wordDisplay: document.getElementById('word-display'),
                wordTopic: document.getElementById('word-topic'),
                wordIpa: document.getElementById('word-ipa'),
                answerInput: document.getElementById('answer-input'),
                checkBtn: document.getElementById('check-btn'),
                nextBtn: document.getElementById('next-btn'),
                learnedCountEl: document.getElementById('learned-count'),
                totalCountEl: document.getElementById('total-count'),
                progressBar: document.getElementById('progress-bar'),
                inputContainer: document.getElementById('input-container'),
                feedbackIcon: document.getElementById('feedback-icon'),
                // Answer Display
                answerDisplay: document.getElementById('answer-display'),
                correctWordEl: document.getElementById('correct-word'),
                correctIpaEl: document.getElementById('correct-ipa'),
                correctMeaningEl: document.getElementById('correct-meaning'),
                mainSpeakerBtn: document.getElementById('main-speaker-btn'),
                answerSpeakerBtn: document.getElementById('answer-speaker-btn'),
                speakBtn: document.getElementById('speak-btn'),
                // Example
                exampleContainer: document.getElementById('example-container'),
                exampleLoader: document.getElementById('example-loader'),
                exampleContent: document.getElementById('example-content'),
                singleExampleContainer: document.getElementById('single-example-container'),
                exampleSentence: document.getElementById('example-sentence'),
                exampleSentenceVi: document.getElementById('example-sentence-vi'),
                singleExampleSpeakerBtn: document.getElementById('single-example-speaker-btn'),
                ieltsExampleContainer: document.getElementById('ielts-example-container'),
                ieltsExampleSentence: document.getElementById('ielts-example-sentence'),
                ieltsExampleSentenceVi: document.getElementById('ielts-example-sentence-vi'),
                ieltsExampleSpeakerBtn: document.getElementById('ielts-example-speaker-btn'),
                commExampleContainer: document.getElementById('comm-example-container'),
                commExampleSentence: document.getElementById('comm-example-sentence'),
                commExampleSentenceVi: document.getElementById('comm-example-sentence-vi'),
                commExampleSpeakerBtn: document.getElementById('comm-example-speaker-btn'),
                exampleError: document.getElementById('example-error'),
                // Gemini
                geminiFeaturesContainer: document.getElementById('gemini-features-container'),
                generateExampleBtn: document.getElementById('generate-example-btn'),
                geminiBtnLoader: document.getElementById('gemini-btn-loader'),
                geminiBtnText: document.getElementById('gemini-btn-text'),
                // Modal
                modal: document.getElementById('modal'),
                modalTitle: document.getElementById('modal-title'),
                modalMessage: document.getElementById('modal-message'),
                modalInputContainer: document.getElementById('modal-input-container'),
                modalInput: document.getElementById('modal-input'),
                modalLoader: document.getElementById('modal-loader'),
                modalButtons: document.getElementById('modal-buttons'),
                modalConfirmBtn: document.getElementById('modal-confirm-btn'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
            };

            const showModal = ({ title, message, hasInput = false, onConfirm, onCancel }) => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modalInputContainer.classList.toggle('hidden', !hasInput);
                DOMElements.modalInput.value = '';
                DOMElements.modalLoader.classList.add('hidden');
                DOMElements.modalButtons.classList.remove('hidden');

                DOMElements.modal.classList.remove('hidden');

                const confirmHandler = () => {
                    if (onConfirm) onConfirm(hasInput ? DOMElements.modalInput.value : undefined);
                    cleanup();
                };

                const cancelHandler = () => {
                    if (onCancel) onCancel();
                    cleanup();
                };

                const cleanup = () => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.modalConfirmBtn.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancelBtn.removeEventListener('click', cancelHandler);
                };

                DOMElements.modalConfirmBtn.addEventListener('click', confirmHandler);
                DOMElements.modalCancelBtn.addEventListener('click', cancelHandler);
            };

            return {
                getDOMElements: () => DOMElements,
                showModal,

                showScreen: (screenId) => {
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.toggle('hidden', screen.id !== screenId);
                    });
                },

                updateProgress: (learnedCount, totalCount) => {
                    DOMElements.learnedCountEl.textContent = learnedCount;
                    DOMElements.totalCountEl.textContent = totalCount;
                    const percentage = totalCount > 0 ? (learnedCount / totalCount) * 100 : 0;
                    DOMElements.progressBar.style.width = `${percentage}%`;
                },

                showAnswerFeedback: (isCorrect, wordData) => {
                    const classes = {
                        bg: isCorrect ? 'bg-green-50' : 'bg-red-50',
                        border: isCorrect ? 'border-green-200' : 'border-red-200',
                        title: isCorrect ? 'text-green-800' : 'text-red-800',
                        word: isCorrect ? 'text-green-900' : 'text-red-900',
                        ipa: isCorrect ? 'text-green-700' : 'text-red-700'
                    };
                    
                    DOMElements.answerDisplay.className = `p-4 rounded-lg opacity-0 ${classes.bg} ${classes.border}`;
                    DOMElements.answerDisplay.querySelector('.answer-title').className = `answer-title text-sm font-semibold ${classes.title}`;
                    DOMElements.answerDisplay.querySelector('.answer-title').textContent = isCorrect ? 'Chính xác!' : 'Đáp án đúng:';
                    DOMElements.correctWordEl.textContent = wordData.Word;
                    DOMElements.correctIpaEl.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                    DOMElements.correctMeaningEl.textContent = wordData.Meaning;
                    
                    // Reset and show loader for the example
                    DOMElements.exampleLoader.classList.remove('hidden');
                    DOMElements.ieltsExampleContainer.classList.add('hidden');
                    DOMElements.commExampleContainer.classList.add('hidden');
                    DOMElements.singleExampleContainer.classList.add('hidden');
                    DOMElements.exampleError.textContent = '';


                    DOMElements.answerDisplay.classList.remove('hidden');
                    setTimeout(() => DOMElements.answerDisplay.classList.remove('opacity-0'), 10);
                },

                displayExamples: ({ ielts, communication, single, error }) => {
                    DOMElements.exampleLoader.classList.add('hidden');
                    
                    if (error) {
                        DOMElements.exampleError.textContent = error;
                    } else if (ielts && communication) {
                        DOMElements.ieltsExampleSentence.textContent = `🇬🇧 ${ielts.english}`;
                        DOMElements.ieltsExampleSentenceVi.textContent = `🇻🇳 ${ielts.vietnamese}`;
                        DOMElements.ieltsExampleContainer.classList.remove('hidden');

                        DOMElements.commExampleSentence.textContent = `🇬🇧 ${communication.english}`;
                        DOMElements.commExampleSentenceVi.textContent = `🇻🇳 ${communication.vietnamese}`;
                        DOMElements.commExampleContainer.classList.remove('hidden');
                    } else if (single) {
                        DOMElements.exampleSentence.textContent = `🇬🇧 ${single.english}`;
                        DOMElements.exampleSentenceVi.textContent = `🇻🇳 ${single.vietnamese}`;
                        DOMElements.singleExampleContainer.classList.remove('hidden');
                    }
                },

                resetUIState: () => {
                    DOMElements.answerInput.value = '';
                    DOMElements.answerInput.disabled = false;
                    DOMElements.answerInput.focus();
                    DOMElements.checkBtn.disabled = false;
                    DOMElements.inputContainer.className = 'relative';
                    DOMElements.feedbackIcon.innerHTML = '';
                    DOMElements.answerDisplay.classList.add('hidden', 'opacity-0');
                },

                updateCard: (wordData, gameMode, packIndex, topicName) => {
                    DOMElements.wordDisplay.textContent = '';
                    DOMElements.wordIpa.textContent = '';
                    DOMElements.mainSpeakerBtn.classList.add('hidden');
                    DOMElements.answerInput.classList.remove('pl-12');
                    DOMElements.speakBtn.classList.add('hidden');

                    if (gameMode === 'en-vi' || gameMode === 'speak') {
                         DOMElements.mainSpeakerBtn.classList.remove('hidden');
                    }

                    if (gameMode === 'en-vi') {
                        DOMElements.instructionText.textContent = "Nhập nghĩa tiếng Việt tương ứng.";
                        DOMElements.wordDisplay.textContent = wordData.Word;
                        DOMElements.wordIpa.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                        DOMElements.answerInput.placeholder = "Gõ nghĩa của từ ở đây...";
                    } else if (gameMode === 'vi-en') {
                        DOMElements.instructionText.textContent = "Nhập từ tiếng Anh tương ứng.";
                        DOMElements.wordDisplay.textContent = wordData.Meaning;
                        DOMElements.answerInput.placeholder = "Gõ từ tiếng Anh ở đây...";
                    } else if (gameMode === 'speak') {
                        DOMElements.instructionText.textContent = "Nhấn loa để nghe, sau đó nhấn micro để nói lại.";
                        DOMElements.wordDisplay.textContent = wordData.Word;
                        DOMElements.wordIpa.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                        DOMElements.answerInput.placeholder = "Nhấn micro để bắt đầu nói...";
                        DOMElements.speakBtn.classList.remove('hidden');
                        DOMElements.answerInput.classList.add('pl-12');
                    } else { // IPA mode
                        DOMElements.instructionText.textContent = "Nhập từ tiếng Anh tương ứng với phiên âm.";
                        DOMElements.wordDisplay.textContent = wordData.IPA ? `/${wordData.IPA}/` : '[Không có IPA]';
                        DOMElements.answerInput.placeholder = "Gõ từ tiếng Anh ở đây...";
                    }

                    if (packIndex > -1) {
                        DOMElements.wordTopic.textContent = `Gói ${packIndex + 1}`;
                    } else if (topicName === 'Ôn tập' || topicName === 'Tất cả') {
                        DOMElements.wordTopic.textContent = wordData.Topic || '';
                    } else {
                        DOMElements.wordTopic.textContent = '';
                    }
                },
                
                showCompletionScreen: (message1, message2) => {
                    DOMElements.wordDisplay.textContent = message1;
                    DOMElements.wordIpa.textContent = message2;
                    DOMElements.mainSpeakerBtn.classList.add('hidden');
                    DOMElements.answerInput.disabled = true;
                    DOMElements.checkBtn.disabled = true;
                },

                setNewExampleLoading: (isLoading) => {
                    DOMElements.geminiBtnLoader.classList.toggle('hidden', !isLoading);
                    DOMElements.generateExampleBtn.disabled = isLoading;
                }
            };
        })();
        
        /**
         * -------------------
         * GEMINI API MODULE
         * Handles calls to the Google Gemini API.
         * -------------------
         */
        const GeminiModule = (() => {
            const API_KEY = ""; // Kept empty as per instructions
            const BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

            async function callApi(payload) {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                return response.json();
            }

            const parseJsonResponse = (result) => {
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) return null;
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse JSON from Gemini:", e);
                    return null;
                }
            };

            return {
                generateAndTranslateExamples: async (word) => {
                    const prompt = `For the English word "${word}", generate two distinct, slightly longer example sentences. One sentence should be formal and suitable for an academic context like the IELTS exam. The other should be informal and suitable for daily communication. For each example, also provide its Vietnamese translation.`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "ieltsExample": {
                                type: "OBJECT",
                                properties: {
                                    "english": { "type": "STRING" },
                                    "vietnamese": { "type": "STRING" }
                                },
                                required: ["english", "vietnamese"]
                            },
                            "communicationExample": {
                                type: "OBJECT",
                                properties: {
                                    "english": { "type": "STRING" },
                                    "vietnamese": { "type": "STRING" }
                                },
                                required: ["english", "vietnamese"]
                            }
                        },
                        required: ["ieltsExample", "communicationExample"]
                    };
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };
                    const result = await callApi(payload);
                    return parseJsonResponse(result);
                },

                translateExample: async (sentence) => {
                    const prompt = `Translate the following English sentence to Vietnamese: "${sentence}"`;
                     const schema = {
                        type: "OBJECT",
                        properties: { "vietnameseExample": { "type": "STRING" } },
                        required: ["vietnameseExample"]
                    };
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };
                    const result = await callApi(payload);
                    return parseJsonResponse(result);
                },

                generateVocabList: async (topic) => {
                    const prompt = `Generate a list of 15 essential English vocabulary words for the topic "${topic}". The list should be diverse and useful for a language learner.`;
                    const schema = {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "Word": { "type": "STRING" },
                                "Meaning": { "type": "STRING", "description": "The Vietnamese translation." },
                                "Example": { "type": "STRING", "description": "A simple English example sentence." }
                            },
                            required: ["Word", "Meaning", "Example"]
                        }
                    };
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };
                    const result = await callApi(payload);
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) return null;
                    const parsedJson = JSON.parse(jsonText);
                    return parsedJson.map(item => ({ ...item, Topic: topic, IPA: ''}));
                }
            };
        })();

        /**
         * -------------------
         * DATA MODULE
         * Handles parsing and managing vocabulary data.
         * -------------------
         */
        const DataModule = (() => {
            let fullList = [];
            let topics = {};
            let orderedTopics = [];

            return {
                loadData: (data, onError) => {
                    if (!data || data.length === 0) {
                        onError("Không có dữ liệu hợp lệ để tải.");
                        return false;
                    }
                    fullList = data;
                    return true;
                },

                parseXLSX: (data, onError) => {
                    try {
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length === 0) {
                             onError('File Excel trống hoặc không có dữ liệu ở sheet đầu tiên.');
                             return null;
                        }

                        const standardizedData = json.map(row => {
                            const wordKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'word');
                            const meaningKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'meaning');
                            const ipaKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'ipa');
                            const topicKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'topic');
                            const exampleKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'example');

                            if (!wordKey || !meaningKey || !row[wordKey] || !row[meaningKey]) return null;

                            return {
                                Word: String(row[wordKey] || '').trim(),
                                Meaning: String(row[meaningKey] || '').trim(),
                                Example: (exampleKey && row[exampleKey]) ? String(row[exampleKey]).trim() : '',
                                Topic: (topicKey && row[topicKey]) ? String(row[topicKey]).trim() : 'Chưa phân loại',
                                IPA: (ipaKey && row[ipaKey]) ? String(row[ipaKey]).trim() : ''
                            };
                        }).filter(Boolean);

                        if (standardizedData.length === 0) {
                            onError('File Excel phải có cột "Word" và "Meaning" và các cột này phải có dữ liệu.');
                            return null;
                        }
                        return standardizedData;
                    } catch (e) {
                        console.error("Error parsing XLSX file:", e);
                        onError("Không thể đọc file Excel. Vui lòng kiểm tra định dạng.");
                        return null;
                    }
                },
                
                getFullList: () => fullList,

                groupTopics: () => {
                    orderedTopics = [];
                    topics = fullList.reduce((acc, word) => {
                        const topic = word.Topic;
                        if (!acc[topic]) {
                            acc[topic] = [];
                            orderedTopics.push(topic);
                        }
                        acc[topic].push(word);
                        return acc;
                    }, {});
                    return { topics, orderedTopics };
                },

                getTopics: () => topics,
            };
        })();

        /**
         * -------------------
         * SPEECH MODULE
         * Uses Google Translate's unofficial TTS endpoint for high-quality audio.
         * -------------------
         */
        const SpeechModule = (() => {
            let currentAudio = null;

            return {
                speak: (text, lang = 'en') => {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    
                    if (text) {
                        const encodedText = encodeURIComponent(text);
                        // Using an unofficial Google Translate TTS endpoint.
                        // This is not a public API and might break without notice.
                        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=${lang}&client=tw-ob`;
                        
                        currentAudio = new Audio(url);
                        currentAudio.play().catch(e => {
                            console.error("Error playing Google TTS audio:", e);
                            UIModule.showModal({ title: "Lỗi Âm thanh", message: "Không thể phát âm thanh. Vui lòng kiểm tra kết nối mạng." });
                        });
                    }
                }
            };
        })();

        /**
         * -------------------
         * APP CONTROLLER
         * The main controller that orchestrates the app.
         * -------------------
         */
        const App = ((UI, Data, Speech, Gemini) => {
            const DOM = UI.getDOMElements();
            let state = {
                sessionVocabularyList: [],
                remainingWords: [],
                currentWord: null,
                learnedWords: new Set(),
                incorrectWords: new Set(),
                gameMode: 'vi-en',
                currentTopicName: '',
                currentPackIndex: -1,
                isReviewSession: false,
                readyForNext: false,
                recognition: null,
                PACK_SIZE: 10
            };

            const normalizeString = (str) => {
                if (typeof str !== 'string') return '';
                return str.normalize('NFC').trim().toLowerCase();
            };
            
            const setupEventListeners = () => {
                DOM.fileInput.addEventListener('change', handleFileSelect);
                DOM.checkBtn.addEventListener('click', checkAnswer);
                DOM.nextBtn.addEventListener('click', () => { if (state.readyForNext) getNewWord(); });
                DOM.answerInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (state.readyForNext) getNewWord();
                        else if (!DOM.checkBtn.disabled) checkAnswer();
                    }
                });

                document.addEventListener('keydown', e => {
                    if (e.code === 'Space' && state.readyForNext) {
                        e.preventDefault();
                        getNewWord();
                    }
                });
                
                DOM.modeSelector.addEventListener('change', e => {
                    state.gameMode = e.target.value;
                    resetGame();
                });
                
                DOM.backToSelectionBtn.addEventListener('click', renderTopicView);
                DOM.backToUploadBtn.addEventListener('click', () => UI.showScreen('upload-section'));

                // Speech
                DOM.mainSpeakerBtn.addEventListener('click', () => { if (state.currentWord) Speech.speak(state.currentWord.Word); });
                DOM.answerSpeakerBtn.addEventListener('click', () => { if (state.currentWord) Speech.speak(state.currentWord.Word); });
                DOM.ieltsExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.ieltsExampleSentence.textContent.replace('🇬🇧 ', '')));
                DOM.commExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.commExampleSentence.textContent.replace('🇬🇧 ', '')));
                DOM.singleExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.exampleSentence.textContent.replace('🇬🇧 ', '')));

                DOM.speakBtn.addEventListener('click', () => {
                    if (state.recognition) {
                        try {
                           DOM.speakBtn.classList.add('mic-listening', 'text-red-500');
                           state.recognition.start();
                        } catch(e) {
                             console.error("Error starting recognition: ", e);
                             DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');
                        }
                    }
                });

                // Gemini
                DOM.generateVocabBtn.addEventListener('click', handleGenerateVocab);
                DOM.generateExampleBtn.addEventListener('click', handleGenerateNewExample);
            };
            
            // --- AI Feature Handlers ---
            const handleGenerateVocab = () => {
                UI.showModal({
                    title: '✨ Tạo bộ từ vựng bằng AI',
                    message: 'Nhập một chủ đề bạn muốn học (ví dụ: "IT support", "travelling", "cooking verbs"). AI sẽ tạo ra một danh sách 15 từ vựng liên quan.',
                    hasInput: true,
                    onConfirm: async (topic) => {
                        if (!topic || topic.trim() === '') return;
                        
                        DOM.modalLoader.classList.remove('hidden');
                        DOM.modalButtons.classList.add('hidden');
                        DOM.modalInputContainer.classList.add('hidden');

                        try {
                            const vocabList = await Gemini.generateVocabList(topic.trim());
                            if (Data.loadData(vocabList, (msg) => UI.showModal({title: 'Lỗi', message: msg}))) {
                                state.incorrectWords.clear();
                                renderTopicView();
                            } else {
                                throw new Error("Generated data was not valid.");
                            }
                        } catch (error) {
                            console.error("Failed to generate vocab list:", error);
                            UI.showModal({title: 'Lỗi', message: 'Không thể tạo danh sách từ vựng. Vui lòng thử lại sau.'});
                        }
                    }
                });
            };
            
            async function fetchAndShowExamples(wordData, forceNew = false) {
                 try {
                    if (wordData.Example && !forceNew) {
                        const result = await Gemini.translateExample(wordData.Example);
                        if(result && result.vietnameseExample) {
                             UI.displayExamples({ single: { english: wordData.Example, vietnamese: result.vietnameseExample } });
                        } else {
                            throw new Error("Translation failed.");
                        }
                    } else {
                        const result = await Gemini.generateAndTranslateExamples(wordData.Word);
                        if(result && result.ieltsExample && result.communicationExample){
                            UI.displayExamples({ 
                                ielts: { english: result.ieltsExample.english, vietnamese: result.ieltsExample.vietnamese },
                                communication: { english: result.communicationExample.english, vietnamese: result.communicationExample.vietnamese }
                            });
                        } else {
                            throw new Error("Generation failed.");
                        }
                    }
                } catch (error) {
                    console.error("Failed to fetch examples:", error);
                    UI.displayExamples({ error: 'Không thể tải ví dụ. Vui lòng thử lại.' });
                }
            }
            
            const handleGenerateNewExample = async () => {
                if (!state.currentWord) return;
                
                UI.setNewExampleLoading(true);
                await fetchAndShowExamples(state.currentWord, true);
                UI.setNewExampleLoading(false);
            };
            
            // --- Core App Logic ---
            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                DOM.fileNameDisplay.textContent = `Đang tải file: ${file.name}`;
                DOM.uploadError.textContent = '';
                if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                    DOM.uploadError.textContent = 'Vui lòng chỉ chọn file có định dạng .xlsx hoặc .xls';
                    DOM.fileNameDisplay.textContent = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    const parsedData = Data.parseXLSX(data, (msg) => { DOM.uploadError.textContent = msg; });
                    if(Data.loadData(parsedData, (msg) => { DOM.uploadError.textContent = msg; })) {
                         state.incorrectWords.clear();
                         renderTopicView();
                    } else {
                         DOM.fileNameDisplay.textContent = '';
                    }
                };
                reader.onerror = () => { DOM.uploadError.textContent = 'Đã có lỗi xảy ra khi đọc file.'; };
                reader.readAsArrayBuffer(file);
            };
            
            const renderTopicView = () => {
                UI.resetUIState();
                DOM.specialSelectionListContainer.innerHTML = '';
                DOM.selectionListContainer.innerHTML = '';
                
                if (state.incorrectWords.size > 0) {
                    const reviewBtn = document.createElement('button');
                    reviewBtn.className = 'w-full text-left bg-orange-500 text-white font-semibold p-4 rounded-lg hover:bg-orange-600 topic-button';
                    reviewBtn.innerHTML = `Ôn tập lại từ sai <span class="font-normal">(${state.incorrectWords.size} từ)</span>`;
                    reviewBtn.onclick = () => {
                        const reviewList = Data.getFullList().filter(word => state.incorrectWords.has(word.Word));
                        state.isReviewSession = true;
                        startGame(reviewList, 'Ôn tập');
                    };
                    DOM.specialSelectionListContainer.appendChild(reviewBtn);
                }

                const { topics, orderedTopics } = Data.groupTopics();
                
                if (Object.keys(topics).length > 1) {
                    const allBtn = document.createElement('button');
                    allBtn.className = 'w-full text-left bg-indigo-500 text-white font-semibold p-4 rounded-lg hover:bg-indigo-600 topic-button';
                    allBtn.textContent = `Học tất cả (${Data.getFullList().length} từ)`;
                    allBtn.onclick = () => startGame(Data.getFullList(), 'Tất cả');
                    DOM.specialSelectionListContainer.appendChild(allBtn);
                }
                
                orderedTopics.forEach(topicName => {
                    const btn = document.createElement('button');
                    btn.className = 'topic-button bg-white border border-slate-200 p-2 rounded-lg flex flex-col justify-center items-center text-center h-28';
                    btn.innerHTML = `
                        <div class="mb-2 text-indigo-500">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        </div>
                        <span class="font-semibold text-slate-800 text-sm w-full break-words px-1">${topicName}</span>
                        <span class="text-xs text-slate-500 mt-1">(${topics[topicName].length} từ)</span>
                    `;
                    btn.onclick = () => {
                        const topicWords = topics[topicName];
                        if (topicWords.length > state.PACK_SIZE) {
                            const firstPack = topicWords.slice(0, state.PACK_SIZE);
                            startGame(firstPack, topicName, 0);
                        } else {
                            startGame(topicWords, topicName);
                        }
                    };
                    DOM.selectionListContainer.appendChild(btn);
                });
                UI.showScreen('topic-section');
            };
            
            const setupPackSelector = (topicName, activePackIndex) => {
                const topicWords = Data.getTopics()[topicName];
                DOM.packSelector.innerHTML = '';
                
                if (!topicWords || topicWords.length <= state.PACK_SIZE) {
                    DOM.packSelectorContainer.classList.add('hidden');
                    return;
                }

                DOM.packSelectorContainer.classList.remove('hidden');

                const numPacks = Math.ceil(topicWords.length / state.PACK_SIZE);
                for (let i = 0; i < numPacks; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Gói ${i + 1}`;
                    if (i === activePackIndex) option.selected = true;
                    DOM.packSelector.appendChild(option);
                }
                 DOM.packSelector.addEventListener('change', (e) => {
                    const newPackIndex = parseInt(e.target.value);
                    const topicWords = Data.getTopics()[state.currentTopicName];
                    if (topicWords) {
                        const start = newPackIndex * state.PACK_SIZE;
                        const newPackWords = topicWords.slice(start, start + state.PACK_SIZE);
                        startGame(newPackWords, state.currentTopicName, newPackIndex);
                    }
                }, { once: true });
            };

            const startGame = (wordList, topicName = '', packIndex = -1) => {
                state.isReviewSession = (topicName === 'Ôn tập');
                state.currentTopicName = topicName;
                state.currentPackIndex = packIndex;
                state.sessionVocabularyList = [...wordList];
                
                DOM.appTitle.textContent = `Chủ đề: ${state.currentTopicName}`;
                
                if (packIndex > -1) {
                    setupPackSelector(state.currentTopicName, state.currentPackIndex);
                } else {
                    DOM.packSelectorContainer.classList.add('hidden');
                }
                
                resetGame();
                UI.showScreen('app-container');
            };
            
            const resetGame = () => {
                state.learnedWords.clear();
                state.remainingWords = [...state.sessionVocabularyList];
                UI.updateProgress(state.learnedWords.size, state.sessionVocabularyList.length);
                getNewWord();
            };

            const getNewWord = () => {
                state.readyForNext = false;
                if (state.remainingWords.length === 0) {
                    const topicWords = Data.getTopics()[state.currentTopicName];
                    const nextPackIndex = state.currentPackIndex + 1;
                    const nextPackStart = nextPackIndex * state.PACK_SIZE;

                    if (!state.isReviewSession && state.currentPackIndex > -1 && topicWords && nextPackStart < topicWords.length) {
                        UI.showCompletionScreen("Tuyệt vời!", `Tự động chuyển sang gói ${nextPackIndex + 1}...`);
                        const nextPackWords = topicWords.slice(nextPackStart, nextPackStart + state.PACK_SIZE);
                        setTimeout(() => startGame(nextPackWords, state.currentTopicName, nextPackIndex), 2500);
                    } else if (state.currentTopicName) {
                        const message = state.isReviewSession ? 'Bạn đã ôn tập xong.' : `Bạn đã hoàn thành chủ đề "${state.currentTopicName}".`
                        UI.showCompletionScreen("Hoàn thành!", message);
                        setTimeout(renderTopicView, 3000);
                    }
                    return;
                }
                const randomIndex = Math.floor(Math.random() * state.remainingWords.length);
                state.currentWord = state.remainingWords[randomIndex];
                UI.updateCard(state.currentWord, state.gameMode, state.currentPackIndex, state.currentTopicName);
                UI.resetUIState();
            };
            
            const checkAnswer = () => {
                if (!state.currentWord || DOM.checkBtn.disabled) return;
                const userAnswer = normalizeString(DOM.answerInput.value);
                if (userAnswer === '') return;
                let isCorrect = false;

                const getCorrectAnswers = (field) => field.split(';').flatMap(part => part.split(',')).map(s => normalizeString(s));
                
                if (state.gameMode === 'en-vi' || state.gameMode === 'speak') {
                    const correctAnswers = getCorrectAnswers(state.currentWord.Meaning);
                    isCorrect = correctAnswers.includes(userAnswer);
                } else {
                    const correctAnswers = getCorrectAnswers(state.currentWord.Word);
                    isCorrect = correctAnswers.includes(userAnswer);
                }
                
                if (isCorrect) handleCorrectAnswer();
                else handleIncorrectAnswer();
            };
            
            const handleCorrectAnswer = () => {
                DOM.inputContainer.classList.add('feedback-correct');
                DOM.feedbackIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>`;
                DOM.answerInput.disabled = true;
                DOM.checkBtn.disabled = true;
                state.readyForNext = true;

                if (!state.learnedWords.has(state.currentWord.Word)) {
                    state.learnedWords.add(state.currentWord.Word);
                }
                state.remainingWords = state.remainingWords.filter(word => word.Word !== state.currentWord.Word);
                
                if (state.isReviewSession) {
                    state.incorrectWords.delete(state.currentWord.Word);
                }
                
                UI.showAnswerFeedback(true, state.currentWord);
                fetchAndShowExamples(state.currentWord);
                UI.updateProgress(state.learnedWords.size, state.sessionVocabularyList.length);
            };

            const handleIncorrectAnswer = () => {
                DOM.inputContainer.classList.add('feedback-incorrect');
                DOM.feedbackIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>`;
                state.incorrectWords.add(state.currentWord.Word);
                DOM.checkBtn.disabled = true;
                DOM.answerInput.disabled = true;
                state.readyForNext = true;
                
                UI.showAnswerFeedback(false, state.currentWord);
                fetchAndShowExamples(state.currentWord);
            };

            const initSpeechRecognition = () => {
                 const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (SpeechRecognition) {
                        state.recognition = new SpeechRecognition();
                        state.recognition.continuous = false;
                        state.recognition.lang = 'en-US';
                        state.recognition.interimResults = false;
                        state.recognition.maxAlternatives = 1;

                        state.recognition.onresult = (event) => {
                            const speechResult = event.results[0][0].transcript;
                            DOM.answerInput.value = speechResult;
                            if (state.gameMode === 'speak') checkAnswer();
                        };

                        state.recognition.onend = () => DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');

                        state.recognition.onerror = (event) => {
                            console.error("Speech recognition error", event.error);
                            let title = "Lỗi Nhận dạng Giọng nói";
                            let message = `Đã xảy ra một lỗi: ${event.error}. Vui lòng thử lại.`;

                            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                                title = "Lỗi Quyền Truy Cập Micro";
                                message = "Để tính năng nhận dạng giọng nói hoạt động, trình duyệt cần được TẢI LẠI TRANG sau khi bạn cấp quyền. Vui lòng nhấn nút Tải lại (Reload) trên trình duyệt hoặc phím F5, sau đó chọn lại chế độ Luyện nói.";
                            } else if (event.error === 'no-speech') {
                                title = "Không nhận dạng được";
                                message = "Không phát hiện được giọng nói. Vui lòng đảm bảo micro hoạt động và bạn đang nói rõ ràng.";
                            } else if (event.error === 'audio-capture') {
                                title = "Lỗi Micro";
                                message = "Không thể thu âm thanh. Vui lòng kiểm tra lại micro của bạn có được kết nối và hoạt động đúng cách không.";
                            }
                            
                            UI.showModal({title: title, message: message});
                            DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');
                        };
                        
                        DOM.speakModeContainer.classList.remove('hidden');
                    }
            }

            return {
                init: () => {
                    UI.showScreen('upload-section');
                    setupEventListeners();
                    initSpeechRecognition();
                }
            };
        })(UIModule, DataModule, SpeechModule, GeminiModule);

        App.init();
    </script>
</body>
</html>
