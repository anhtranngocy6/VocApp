<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán T·∫≠p Ghi Nh·ªõ T·ª´ V·ª±ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            width: 100%;
        }
        .screen-wrapper {
             position: relative;
             min-height: 500px;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        .feedback-correct {
            animation: flash-green 0.8s;
        }
        .feedback-incorrect {
            animation: flash-red 0.8s;
        }
        @keyframes flash-green {
            0%, 100% { background-color: #fff; }
            50% { background-color: #f0fdf4; }
        }
        @keyframes flash-red {
            0%, 100% { background-color: #fff; }
            50% { background-color: #fef2f2; }
        }
        #answer-display, #gemini-features-container {
            transition: all 0.3s ease-in-out;
        }
        .topic-button, .mode-button {
            transition: all 0.2s ease-in-out;
        }
        .topic-button:hover, .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #a5b4fc;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .mic-listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Scrollbar for Pack Selector */
        #pack-buttons-container::-webkit-scrollbar {
            height: 4px;
        }
        #pack-buttons-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #pack-buttons-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        #pack-buttons-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .progress-bar > div {
            transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto screen-wrapper">
        <!-- Section 1: Upload -->
        <div id="upload-section" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 mb-6">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800 mb-2">B·∫Øt ƒë·∫ßu Luy·ªán t·∫≠p</h1>
                    <p class="text-slate-600 mb-6">T·∫£i l√™n file t·ª´ v·ª±ng c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                    <div class="space-y-4">
                        <label for="file-input" class="w-full inline-block bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-300 cursor-pointer shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50">
                            Ch·ªçn File Excel
                        </label>
                        <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                    <div class="mt-6">
                        <button id="clear-data-btn" class="text-sm text-slate-500 hover:text-red-600 transition-colors">X√≥a d·ªØ li·ªáu c≈© & B·∫Øt ƒë·∫ßu l·∫°i</button>
                    </div>
                    <p id="file-name-display" class="text-sm text-slate-500 mt-4 h-5"></p>
                    <p id="upload-error" class="text-sm text-red-500 mt-1 h-5"></p>
                </div>

                <!-- Excel Format Instructions -->
                <div class="mt-8 pt-6 border-t border-slate-200 text-left">
                    <h3 class="text-lg font-semibold text-slate-700 mb-3">H∆∞·ªõng d·∫´n t·∫°o file Excel</h3>
                    <p class="text-sm text-slate-600 mb-4">File Excel c·ªßa b·∫°n c·∫ßn c√≥ c√°c c·ªôt v·ªõi ti√™u ƒë·ªÅ sau ·ªü h√†ng ƒë·∫ßu ti√™n:</p>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">Word</code> (<strong>B·∫Øt bu·ªôc</strong>): T·ª´ v·ª±ng ti·∫øng Anh.</li>
                        <li><code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">Meaning</code> (<strong>B·∫Øt bu·ªôc</strong>): Nghƒ©a ti·∫øng Vi·ªát c·ªßa t·ª´.</li>
                        <li><code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">Topic</code> (T√πy ch·ªçn): Ch·ªß ƒë·ªÅ c·ªßa t·ª´, v√≠ d·ª•: <code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">Adjectives (T√≠nh t·ª´)</code>.</li>
                        <li><code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">IPA</code> (T√πy ch·ªçn): Phi√™n √¢m qu·ªëc t·∫ø c·ªßa t·ª´.</li>
                        <li><code class="bg-slate-100 text-slate-800 font-mono py-0.5 px-1.5 rounded-md">Example</code> (T√πy ch·ªçn): C√¢u v√≠ d·ª• b·∫±ng ti·∫øng Anh.</li>
                    </ul>
                    <div class="mt-5">
                         <button id="download-sample-btn" class="w-full sm:w-auto bg-white text-indigo-600 font-semibold py-2 px-4 rounded-lg border-2 border-indigo-500 hover:bg-indigo-50 transition-all duration-300 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            T·∫£i file m·∫´u
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Section 1.5: Mode Selection -->
        <div id="mode-selection-section" class="screen hidden">
             <div class="bg-white p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <header class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-slate-800">Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p</h1>
                    <p class="text-slate-500 mt-1">M·ªói ch·∫ø ƒë·ªô s·∫Ω c√≥ ti·∫øn ƒë·ªô h·ªçc ri√™ng.</p>
                </header>
                <div class="space-y-4">
                    <button id="select-mode-vi-en" data-mode="vi-en" class="mode-button w-full text-left p-5 rounded-lg border-2 border-slate-200 hover:border-indigo-500 flex items-center gap-5">
                        <span class="text-3xl">üáªüá≥‚Üíüá¨üáß</span>
                        <div>
                            <h3 class="font-bold text-slate-800">Vi·ªát ‚Üí Anh</h3>
                            <p class="text-sm text-slate-600">Nh√¨n nghƒ©a ti·∫øng Vi·ªát, ƒëo√°n t·ª´ ti·∫øng Anh.</p>
                        </div>
                    </button>
                    <button id="select-mode-en-vi" data-mode="en-vi" class="mode-button w-full text-left p-5 rounded-lg border-2 border-slate-200 hover:border-indigo-500 flex items-center gap-5">
                        <span class="text-3xl">üá¨üáß‚Üíüáªüá≥</span>
                        <div>
                            <h3 class="font-bold text-slate-800">Anh ‚Üí Vi·ªát</h3>
                            <p class="text-sm text-slate-600">Nh√¨n t·ª´ ti·∫øng Anh, ƒëo√°n nghƒ©a ti·∫øng Vi·ªát.</p>
                        </div>
                    </button>
                    <button id="select-mode-speak" data-mode="speak" class="mode-button w-full text-left p-5 rounded-lg border-2 border-slate-200 hover:border-indigo-500 flex items-center gap-5">
                        <span class="text-3xl">üó£Ô∏è</span>
                         <div>
                            <h3 class="font-bold text-slate-800">Luy·ªán N√≥i (Anh)</h3>
                            <p class="text-sm text-slate-600">Nghe v√† ph√°t √¢m l·∫°i t·ª´ v·ª±ng.</p>
                        </div>
                    </button>
                </div>
                 <button id="back-to-upload-btn-from-mode" class="mt-8 w-full text-center text-sm text-slate-500 hover:text-indigo-600 font-medium">B·∫Øt ƒë·∫ßu phi√™n m·ªõi (t·∫£i file kh√°c)</button>
             </div>
        </div>
        
        <!-- Section 2: Topic Selection -->
        <div id="topic-section" class="screen hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <header class="text-center mb-6 relative">
                     <button id="back-to-mode-selection-btn" class="absolute left-0 top-1 text-slate-500 hover:text-indigo-600 transition-colors" title="Quay l·∫°i ch·ªçn ch·∫ø ƒë·ªô">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <h1 id="selection-header" class="text-2xl font-bold text-slate-800">Ch·ªçn Ch·ªß ƒê·ªÅ</h1>
                    <p id="selection-subheader" class="text-slate-500">T·∫≠p trung v√†o m·ªôt ch·ªß ƒë·ªÅ ƒë·ªÉ h·ªçc hi·ªáu qu·∫£ h∆°n.</p>
                </header>
                 <div id="special-selection-list" class="space-y-3 mb-6">
                    <!-- Review and All buttons will be inserted here -->
                 </div>
                <div id="selection-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[28rem] overflow-y-auto p-1">
                    <!-- Topic/Pack buttons will be inserted here -->
                </div>
             </div>
        </div>

        <!-- Section 3: Main App -->
        <div id="app-container" class="screen hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl shadow-slate-300/60">
                <header class="text-center mb-4 relative">
                    <button id="back-to-topic-selection-btn" class="absolute left-0 top-1 text-slate-500 hover:text-indigo-600 transition-colors" title="Quay l·∫°i ch·ªçn ch·ªß ƒë·ªÅ">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <h1 id="app-title" class="text-xl md:text-2xl font-bold text-slate-800">Topic: </h1>
                    <p id="instruction-text" class="text-slate-500">Nh·∫≠p nghƒ©a t∆∞∆°ng ·ª©ng c·ªßa t·ª´ b√™n d∆∞·ªõi.</p>
                </header>

                <main>
                    <div id="pack-selector-container" class="hidden mb-4">
                        <div id="pack-buttons-container" class="flex items-center gap-2 overflow-x-auto pb-2 -mb-2">
                            <!-- Pack buttons will be inserted here by JavaScript -->
                        </div>
                    </div>
                    
                    <div id="card-display" class="relative w-full min-h-[10rem] bg-slate-50 border border-slate-200 rounded-xl flex flex-col justify-center items-center p-4 my-6 text-center">
                        <span id="word-topic" class="absolute top-2.5 right-3 text-xs bg-slate-200 text-slate-600 font-medium px-2 py-1 rounded-full"></span>
                        <div class="flex items-center gap-2">
                            <h2 id="word-display" class="text-3xl md:text-4xl font-bold text-indigo-600 px-2"></h2>
                            <button id="main-speaker-btn" class="hidden text-slate-400 hover:text-indigo-600 transition-colors">
                                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                            </button>
                        </div>
                        <p id="word-ipa" class="text-xl text-slate-500 mt-2"></p>
                    </div>

                    <div class="space-y-4">
                        <div id="input-container" class="relative">
                            <button id="speak-btn" class="hidden absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 p-1 rounded-full">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" /><path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.75 6.75 0 11-13.5 0v-1.5A.75.75 0 016 10.5z" /></svg>
                            </button>
                            <input type="text" id="answer-input" placeholder="G√µ c√¢u tr·∫£ l·ªùi ·ªü ƒë√¢y..." class="w-full px-4 py-3.5 text-lg border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
                            <div id="feedback-icon" class="absolute right-4 top-1/2 -translate-y-1/2"></div>
                        </div>
                        
                        <div id="answer-display" class="hidden opacity-0 p-4 rounded-lg">
                             <div class="flex items-center justify-between">
                                <p class="answer-title text-sm font-semibold"></p>
                                <button id="answer-speaker-btn" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                </button>
                             </div>
                             <p class="answer-word text-lg font-bold" id="correct-word"></p>
                             <p class="answer-ipa text-md" id="correct-ipa"></p>
                             <p class="answer-meaning text-md font-semibold mt-1" id="correct-meaning"></p>
                             
                             <!-- Example Container -->
                             <div id="example-container" class="mt-3 pt-3 border-t border-slate-200/80">
                                 <div id="example-loader" class="hidden items-center">
                                      <div class="loader !w-4 !h-4 !border-teal-500 !border-b-transparent"></div>
                                      <span class="text-xs text-slate-500 ml-2">AI ƒëang t·∫°o v√≠ d·ª•...</span>
                                 </div>
                                 <div id="example-content" class="text-sm space-y-3">
                                      <!-- IELTS Example -->
                                      <div id="ielts-example-container" class="hidden">
                                           <div class="flex items-center justify-between">
                                               <p class="font-semibold text-slate-700">V√≠ d·ª• (IELTS):</p>
                                               <button id="ielts-example-speaker-btn" title="ƒê·ªçc c√¢u v√≠ d·ª• IELTS" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                   <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                               </button>
                                           </div>
                                          <p id="ielts-example-sentence" class="text-slate-800"></p>
                                          <p id="ielts-example-sentence-vi" class="text-slate-600"></p>
                                      </div>
                                      <!-- Communication Example -->
                                      <div id="comm-example-container" class="hidden">
                                           <div class="flex items-center justify-between">
                                               <p class="font-semibold text-slate-700">V√≠ d·ª• (Giao ti·∫øp):</p>
                                               <button id="comm-example-speaker-btn" title="ƒê·ªçc c√¢u v√≠ d·ª• Giao ti·∫øp" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                   <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                               </button>
                                           </div>
                                          <p id="comm-example-sentence" class="text-slate-800"></p>
                                          <p id="comm-example-sentence-vi" class="text-slate-600"></p>
                                      </div>
                                      <!-- Single pre-existing example -->
                                      <div id="single-example-container" class="hidden">
                                           <div class="flex items-center justify-between">
                                               <p class="font-semibold text-slate-700">V√≠ d·ª•:</p>
                                               <button id="single-example-speaker-btn" title="ƒê·ªçc c√¢u v√≠ d·ª•" class="text-slate-400 hover:text-indigo-600 transition-colors">
                                                   <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                               </button>
                                           </div>
                                          <p id="example-sentence" class="text-slate-800"></p>
                                          <p id="example-sentence-vi" class="text-slate-600"></p>
                                      </div>
                                      <p id="example-error" class="text-xs text-red-500"></p>
                                 </div>
                             </div>

                             <!-- Gemini Features Container -->
                             <div id="gemini-features-container" class="mt-3 pt-3 border-t border-slate-200/80">
                                 <button id="generate-example-btn" class="text-sm font-medium text-teal-600 hover:text-teal-700 flex items-center gap-1.5">
                                    <span id="gemini-btn-loader" class="hidden"><span class="loader !w-4 !h-4"></span></span>
                                    <span id="gemini-btn-text">‚ú® T·∫°o v√≠ d·ª• kh√°c</span>
                                 </button>
                             </div>

                             <!-- NEW: Related Words Container -->
                             <div id="related-words-section" class="hidden mt-3 pt-3 border-t border-slate-200/80">
                                <button id="find-related-btn" class="text-sm font-medium text-blue-600 hover:text-blue-700 flex items-center gap-1.5">
                                    üîç T√¨m t·ª´ li√™n quan (ƒë·ªìng nghƒ©a/tr√°i nghƒ©a)
                                </button>
                                <div id="related-words-loader" class="hidden items-center mt-2">
                                    <div class="loader !w-4 !h-4 !border-blue-500 !border-b-transparent"></div>
                                    <span class="text-xs text-slate-500 ml-2">AI ƒëang t√¨m ki·∫øm...</span>
                                </div>
                                <div id="related-words-content" class="hidden mt-2 text-sm space-y-3">
                                    <div id="original-word-context-container" class="mb-3">
                                        <p class="font-bold text-slate-700">Ng·ªØ c·∫£nh t·ª´ g·ªëc (<span id="original-word-display" class="italic"></span>):</p>
                                        <p id="original-word-context" class="text-slate-600"></p>
                                    </div>
                                    <div id="synonyms-container">
                                        <p class="font-bold text-slate-700">T·ª´ ƒë·ªìng nghƒ©a:</p>
                                        <div id="synonyms-list" class="text-slate-800 space-y-2"></div>
                                    </div>
                                    <div id="antonyms-container" class="mt-2">
                                        <p class="font-bold text-slate-700">T·ª´ tr√°i nghƒ©a:</p>
                                        <div id="antonyms-list" class="text-slate-800 space-y-2"></div>
                                    </div>
                                    <p id="related-words-error" class="text-xs text-red-500"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button id="check-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Ki·ªÉm Tra</button>
                            <button id="next-btn" class="w-full bg-slate-700 text-white font-semibold py-3 rounded-lg hover:bg-slate-800 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">T·ª´ Ti·∫øp Theo</button>
                        </div>
                    </div>

                    <!-- New Stats Container -->
                    <div id="stats-container" class="mt-8 space-y-6">
                        <!-- Content will be generated by JavaScript -->
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modal for general messages and Gemini topic input -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="modal-message" class="text-slate-600 mb-4"></p>
            <div id="modal-input-container" class="hidden mb-4">
                 <input type="text" id="modal-input" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ ·ªü ƒë√¢y..." class="w-full px-3 py-2 text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="modal-loader" class="hidden my-4 flex justify-center"><div class="loader"></div></div>
            <div id="modal-buttons">
                <button id="modal-confirm-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors w-full">X√°c nh·∫≠n</button>
                <button id="modal-cancel-btn" class="mt-2 text-sm text-slate-600 hover:bg-slate-100 py-2 px-4 rounded-lg">H·ªßy</button>
            </div>
        </div>
    </div>
    
    <script>
        /**
         * -------------------
         * UI MODULE
         * Handles all direct DOM manipulations and UI updates.
         * -------------------
         */
        const UIModule = (() => {
            const DOMElements = {
                // Screens
                uploadSection: document.getElementById('upload-section'),
                modeSelectionSection: document.getElementById('mode-selection-section'),
                topicSection: document.getElementById('topic-section'),
                appContainer: document.getElementById('app-container'),
                // Upload
                fileInput: document.getElementById('file-input'),
                fileNameDisplay: document.getElementById('file-name-display'),
                uploadError: document.getElementById('upload-error'),
                clearDataBtn: document.getElementById('clear-data-btn'),
                downloadSampleBtn: document.getElementById('download-sample-btn'),
                 // Mode Selection
                selectModeViEnBtn: document.getElementById('select-mode-vi-en'),
                selectModeEnViBtn: document.getElementById('select-mode-en-vi'),
                selectModeSpeakBtn: document.getElementById('select-mode-speak'),
                backToUploadBtnFromMode: document.getElementById('back-to-upload-btn-from-mode'),
                // Topic Selection
                selectionHeader: document.getElementById('selection-header'),
                selectionSubheader: document.getElementById('selection-subheader'),
                specialSelectionListContainer: document.getElementById('special-selection-list'),
                selectionListContainer: document.getElementById('selection-list'),
                backToModeSelectionBtn: document.getElementById('back-to-mode-selection-btn'),
                // App
                appTitle: document.getElementById('app-title'),
                backToTopicSelectionBtn: document.getElementById('back-to-topic-selection-btn'),
                packSelectorContainer: document.getElementById('pack-selector-container'),
                packButtonsContainer: document.getElementById('pack-buttons-container'),
                instructionText: document.getElementById('instruction-text'),
                wordDisplay: document.getElementById('word-display'),
                wordTopic: document.getElementById('word-topic'),
                wordIpa: document.getElementById('word-ipa'),
                answerInput: document.getElementById('answer-input'),
                checkBtn: document.getElementById('check-btn'),
                nextBtn: document.getElementById('next-btn'),
                statsContainer: document.getElementById('stats-container'),
                inputContainer: document.getElementById('input-container'),
                feedbackIcon: document.getElementById('feedback-icon'),
                // Answer Display
                answerDisplay: document.getElementById('answer-display'),
                correctWordEl: document.getElementById('correct-word'),
                correctIpaEl: document.getElementById('correct-ipa'),
                correctMeaningEl: document.getElementById('correct-meaning'),
                mainSpeakerBtn: document.getElementById('main-speaker-btn'),
                answerSpeakerBtn: document.getElementById('answer-speaker-btn'),
                speakBtn: document.getElementById('speak-btn'),
                // Example
                exampleContainer: document.getElementById('example-container'),
                exampleLoader: document.getElementById('example-loader'),
                exampleContent: document.getElementById('example-content'),
                singleExampleContainer: document.getElementById('single-example-container'),
                exampleSentence: document.getElementById('example-sentence'),
                exampleSentenceVi: document.getElementById('example-sentence-vi'),
                singleExampleSpeakerBtn: document.getElementById('single-example-speaker-btn'),
                ieltsExampleContainer: document.getElementById('ielts-example-container'),
                ieltsExampleSentence: document.getElementById('ielts-example-sentence'),
                ieltsExampleSentenceVi: document.getElementById('ielts-example-sentence-vi'),
                ieltsExampleSpeakerBtn: document.getElementById('ielts-example-speaker-btn'),
                commExampleContainer: document.getElementById('comm-example-container'),
                commExampleSentence: document.getElementById('comm-example-sentence'),
                commExampleSentenceVi: document.getElementById('comm-example-sentence-vi'),
                commExampleSpeakerBtn: document.getElementById('comm-example-speaker-btn'),
                exampleError: document.getElementById('example-error'),
                // Gemini
                geminiFeaturesContainer: document.getElementById('gemini-features-container'),
                generateExampleBtn: document.getElementById('generate-example-btn'),
                geminiBtnLoader: document.getElementById('gemini-btn-loader'),
                geminiBtnText: document.getElementById('gemini-btn-text'),
                // Related Words
                relatedWordsSection: document.getElementById('related-words-section'),
                findRelatedBtn: document.getElementById('find-related-btn'),
                relatedWordsLoader: document.getElementById('related-words-loader'),
                relatedWordsContent: document.getElementById('related-words-content'),
                originalWordContextContainer: document.getElementById('original-word-context-container'),
                originalWordDisplay: document.getElementById('original-word-display'),
                originalWordContext: document.getElementById('original-word-context'),
                synonymsContainer: document.getElementById('synonyms-container'),
                synonymsList: document.getElementById('synonyms-list'),
                antonymsContainer: document.getElementById('antonyms-container'),
                antonymsList: document.getElementById('antonyms-list'),
                relatedWordsError: document.getElementById('related-words-error'),
                // Modal
                modal: document.getElementById('modal'),
                modalTitle: document.getElementById('modal-title'),
                modalMessage: document.getElementById('modal-message'),
                modalInputContainer: document.getElementById('modal-input-container'),
                modalInput: document.getElementById('modal-input'),
                modalLoader: document.getElementById('modal-loader'),
                modalButtons: document.getElementById('modal-buttons'),
                modalConfirmBtn: document.getElementById('modal-confirm-btn'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
            };

            const showModal = ({ title, message, hasInput = false, onConfirm, onCancel }) => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modalInputContainer.classList.toggle('hidden', !hasInput);
                DOMElements.modalInput.value = '';
                DOMElements.modalLoader.classList.add('hidden');
                DOMElements.modalButtons.classList.remove('hidden');

                DOMElements.modal.classList.remove('hidden');

                const confirmHandler = () => {
                    if (onConfirm) onConfirm(hasInput ? DOMElements.modalInput.value : undefined);
                    cleanup();
                };

                const cancelHandler = () => {
                    if (onCancel) onCancel();
                    cleanup();
                };

                const cleanup = () => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.modalConfirmBtn.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancelBtn.removeEventListener('click', cancelHandler);
                };

                DOMElements.modalConfirmBtn.addEventListener('click', confirmHandler);
                DOMElements.modalCancelBtn.addEventListener('click', cancelHandler);
            };

            return {
                getDOMElements: () => DOMElements,
                showModal,

                showScreen: (screenId) => {
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.toggle('hidden', screen.id !== screenId);
                    });
                },

                renderPackButtons: (packs, activeIndex, clickHandler) => {
                    const container = DOMElements.packButtonsContainer;
                    container.innerHTML = '';
                    if (!packs || packs.length === 0) {
                        DOMElements.packSelectorContainer.classList.add('hidden');
                        return;
                    }
                    DOMElements.packSelectorContainer.classList.remove('hidden');
                    
                    packs.forEach(pack => {
                        const button = document.createElement('button');
                        
                        const baseClasses = 'px-4 py-2 text-sm font-semibold rounded-md transition-colors whitespace-nowrap';
                        const activeClasses = 'bg-indigo-600 text-white shadow';
                        const completedClasses = 'bg-teal-500 text-white hover:bg-teal-600';
                        const inProgressClasses = 'bg-yellow-100 text-yellow-800 border border-yellow-300 hover:bg-yellow-200';
                        const inactiveClasses = 'bg-white text-slate-700 hover:bg-slate-100 border border-slate-300';
                        
                        if (pack.index === activeIndex) {
                             button.className = `${baseClasses} ${activeClasses}`;
                        } else if (pack.isCompleted) {
                            button.className = `${baseClasses} ${completedClasses}`;
                        } else if (pack.isInProgress) {
                            button.className = `${baseClasses} ${inProgressClasses}`;
                        }
                        else {
                            button.className = `${baseClasses} ${inactiveClasses}`;
                        }

                        button.textContent = `G√≥i ${pack.index + 1}`;
                        button.onclick = () => clickHandler(pack.index);
                        container.appendChild(button);
                    });
                },

                renderStats: (stats) => {
                    const topicPercentage = stats.topicTotal > 0 ? (stats.topicMastered / stats.topicTotal) * 100 : 0;
                    const sessionStatsHTML = `
                        <div>
                            <h3 class="text-sm font-semibold text-slate-600 mb-3 text-center">Ti·∫øn ƒê·ªô Phi√™n H·ªçc</h3>
                            <div class="grid grid-cols-3 gap-2 text-center mb-3">
                                <div>
                                    <div class="flex items-center justify-center gap-1 text-green-500">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                                        <span class="text-2xl font-bold">${stats.sessionCorrect}</span>
                                    </div>
                                    <p class="text-xs text-slate-500">Ch√≠nh x√°c</p>
                                </div>
                                <div>
                                    <div class="flex items-center justify-center gap-1 text-red-500">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                                        <span class="text-2xl font-bold">${stats.sessionIncorrect}</span>
                                    </div>
                                    <p class="text-xs text-slate-500">Sai</p>
                                </div>
                                <div>
                                    <div class="flex items-center justify-center gap-1 text-slate-500">
                                         <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>
                                        <span class="text-2xl font-bold">${stats.sessionRemaining}</span>
                                    </div>
                                    <p class="text-xs text-slate-500">C√≤n l·∫°i</p>
                                </div>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: ${stats.sessionPercentage}%"></div>
                            </div>
                        </div>`;

                    const topicStatsHTML = stats.showTopicStats ? `
                        <div class="border-t border-slate-200 pt-5">
                            <h3 class="text-sm font-semibold text-slate-600 mb-3 text-center">Ti·∫øn ƒê·ªô To√†n Ch·ªß ƒê·ªÅ</h3>
                             <div class="flex justify-center items-center">
                                <div class="relative w-24 h-24 rounded-full flex items-center justify-center" style="background: radial-gradient(closest-side, white 79%, transparent 80% 100%), conic-gradient(#14b8a6 ${topicPercentage}%, #e2e8f0 0)">
                                     <span class="text-xl font-bold text-slate-700">${Math.round(topicPercentage)}%</span>
                                </div>
                                <div class="ml-6 text-left">
                                    <p class="text-sm text-slate-600">ƒê√£ th√†nh th·∫°o:</p>
                                    <p class="text-2xl font-bold text-slate-800">${stats.topicMastered} <span class="text-lg font-medium text-slate-500">/ ${stats.topicTotal} t·ª´</span></p>
                                </div>
                            </div>
                        </div>` : '';
                    
                    DOMElements.statsContainer.innerHTML = sessionStatsHTML + topicStatsHTML;
                },

                showAnswerFeedback: (isCorrect, wordData) => {
                    const classes = {
                        bg: isCorrect ? 'bg-green-50' : 'bg-red-50',
                        border: isCorrect ? 'border-green-200' : 'border-red-200',
                        title: isCorrect ? 'text-green-800' : 'text-red-800',
                    };
                    
                    DOMElements.answerDisplay.className = `p-4 rounded-lg opacity-0 ${classes.bg} ${classes.border}`;
                    DOMElements.answerDisplay.querySelector('.answer-title').className = `answer-title text-sm font-semibold ${classes.title}`;
                    DOMElements.answerDisplay.querySelector('.answer-title').textContent = isCorrect ? 'Ch√≠nh x√°c!' : 'ƒê√°p √°n ƒë√∫ng:';
                    DOMElements.correctWordEl.textContent = wordData.Word;
                    DOMElements.correctIpaEl.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                    DOMElements.correctMeaningEl.textContent = wordData.Meaning;
                    
                    // Reset and show loader for the example
                    DOMElements.exampleLoader.classList.remove('hidden');
                    DOMElements.ieltsExampleContainer.classList.add('hidden');
                    DOMElements.commExampleContainer.classList.add('hidden');
                    DOMElements.singleExampleContainer.classList.add('hidden');
                    DOMElements.exampleError.textContent = '';

                    // Reset and show the related words button
                    DOMElements.relatedWordsSection.classList.remove('hidden');
                    DOMElements.findRelatedBtn.classList.remove('hidden');
                    DOMElements.relatedWordsLoader.classList.add('hidden');
                    DOMElements.relatedWordsContent.classList.add('hidden');
                    DOMElements.relatedWordsError.textContent = '';

                    DOMElements.answerDisplay.classList.remove('hidden');
                    setTimeout(() => DOMElements.answerDisplay.classList.remove('opacity-0'), 10);
                },

                displayExamples: ({ ielts, communication, single, error }) => {
                    DOMElements.exampleLoader.classList.add('hidden');
                    
                    if (error) {
                        DOMElements.exampleError.textContent = error;
                    } else if (ielts && communication) {
                        DOMElements.ieltsExampleSentence.textContent = `üá¨üáß ${ielts.english}`;
                        DOMElements.ieltsExampleSentenceVi.textContent = `üáªüá≥ ${ielts.vietnamese}`;
                        DOMElements.ieltsExampleContainer.classList.remove('hidden');

                        DOMElements.commExampleSentence.textContent = `üá¨üáß ${communication.english}`;
                        DOMElements.commExampleSentenceVi.textContent = `üáªüá≥ ${communication.vietnamese}`;
                        DOMElements.commExampleContainer.classList.remove('hidden');
                    } else if (single) {
                        DOMElements.exampleSentence.textContent = `üá¨üáß ${single.english}`;
                        DOMElements.exampleSentenceVi.textContent = `üáªüá≥ ${single.vietnamese}`;
                        DOMElements.singleExampleContainer.classList.remove('hidden');
                    }
                },

                resetUIState: () => {
                    DOMElements.answerInput.value = '';
                    DOMElements.answerInput.disabled = false;
                    DOMElements.answerInput.focus();
                    DOMElements.checkBtn.disabled = false;
                    DOMElements.inputContainer.className = 'relative';
                    DOMElements.feedbackIcon.innerHTML = '';
                    DOMElements.answerDisplay.classList.add('hidden', 'opacity-0');
                    DOMElements.relatedWordsSection.classList.add('hidden');
                },

                updateCard: (wordData, gameMode, packIndex, topicName) => {
                    DOMElements.wordDisplay.textContent = '';
                    DOMElements.wordIpa.textContent = '';
                    DOMElements.mainSpeakerBtn.classList.add('hidden');
                    DOMElements.answerInput.classList.remove('pl-12');
                    DOMElements.speakBtn.classList.add('hidden');

                    if (gameMode === 'en-vi' || gameMode === 'speak') {
                         DOMElements.mainSpeakerBtn.classList.remove('hidden');
                    }

                    if (gameMode === 'en-vi') {
                        DOMElements.instructionText.textContent = "Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát t∆∞∆°ng ·ª©ng.";
                        DOMElements.wordDisplay.textContent = wordData.Word;
                        DOMElements.wordIpa.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                        DOMElements.answerInput.placeholder = "G√µ nghƒ©a c·ªßa t·ª´ ·ªü ƒë√¢y...";
                    } else if (gameMode === 'vi-en') {
                        DOMElements.instructionText.textContent = "Nh·∫≠p t·ª´ ti·∫øng Anh t∆∞∆°ng ·ª©ng.";
                        DOMElements.wordDisplay.textContent = wordData.Meaning;
                        DOMElements.answerInput.placeholder = "G√µ t·ª´ ti·∫øng Anh ·ªü ƒë√¢y...";
                    } else if (gameMode === 'speak') {
                        DOMElements.instructionText.textContent = "Nh·∫•n loa ƒë·ªÉ nghe, sau ƒë√≥ nh·∫•n micro ƒë·ªÉ n√≥i l·∫°i.";
                        DOMElements.wordDisplay.textContent = wordData.Word;
                        DOMElements.wordIpa.textContent = wordData.IPA ? `/${wordData.IPA}/` : '';
                        DOMElements.answerInput.placeholder = "Nh·∫•n micro ƒë·ªÉ b·∫Øt ƒë·∫ßu n√≥i...";
                        DOMElements.speakBtn.classList.remove('hidden');
                        DOMElements.answerInput.classList.add('pl-12');
                    } else { // IPA mode
                        DOMElements.instructionText.textContent = "Nh·∫≠p t·ª´ ti·∫øng Anh t∆∞∆°ng ·ª©ng v·ªõi phi√™n √¢m.";
                        DOMElements.wordDisplay.textContent = wordData.IPA ? `/${wordData.IPA}/` : '[Kh√¥ng c√≥ IPA]';
                        DOMElements.answerInput.placeholder = "G√µ t·ª´ ti·∫øng Anh ·ªü ƒë√¢y...";
                    }

                    if (packIndex > -1) {
                        DOMElements.wordTopic.textContent = `G√≥i ${packIndex + 1}`;
                    } else if (topicName === '√în t·∫≠p' || topicName === 'T·∫•t c·∫£') {
                        DOMElements.wordTopic.textContent = wordData.Topic || '';
                    } else {
                        DOMElements.wordTopic.textContent = '';
                    }
                },
                
                showCompletionScreen: (message1, message2) => {
                    DOMElements.wordDisplay.textContent = message1;
                    DOMElements.wordIpa.textContent = message2;
                    DOMElements.mainSpeakerBtn.classList.add('hidden');
                    DOMElements.answerInput.disabled = true;
                    DOMElements.checkBtn.disabled = true;
                },

                setNewExampleLoading: (isLoading) => {
                    DOMElements.geminiBtnLoader.classList.toggle('hidden', !isLoading);
                    DOMElements.generateExampleBtn.disabled = isLoading;
                },

                setRelatedWordsLoading: (isLoading) => {
                    DOMElements.findRelatedBtn.classList.add('hidden');
                    DOMElements.relatedWordsLoader.style.display = isLoading ? 'flex' : 'none';
                    if (!isLoading) {
                        DOMElements.relatedWordsContent.classList.remove('hidden');
                    }
                },

                displayRelatedWords: ({ originalWord, originalWordContext, synonyms, antonyms, error }) => {
                    const formatWords = (wordArray) => {
                        if (!wordArray || wordArray.length === 0) return '<p>Kh√¥ng t√¨m th·∫•y.</p>';
                        return wordArray.map(w =>
                            `<div class="mt-2 flex items-start gap-2">
                                <button class="related-speaker-btn flex-shrink-0 pt-1 focus:outline-none" data-word="${w.english}" title="ƒê·ªçc t·ª´ n√†y">
                                    <svg class="w-4 h-4 text-slate-500 hover:text-indigo-600 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" /></svg>
                                </button>
                                <p class="flex-grow">
                                    <strong class="text-slate-900">${w.english}</strong> (${w.vietnamese}):
                                    <span class="text-slate-600">${w.context}</span>
                                </p>
                            </div>`
                        ).join('');
                    };

                    if (error) {
                        DOMElements.relatedWordsError.textContent = error;
                        DOMElements.originalWordContextContainer.classList.add('hidden');
                        DOMElements.synonymsContainer.classList.add('hidden');
                        DOMElements.antonymsContainer.classList.add('hidden');
                    } else {
                        DOMElements.relatedWordsError.textContent = '';

                        DOMElements.originalWordDisplay.textContent = originalWord;
                        DOMElements.originalWordContext.textContent = originalWordContext;
                        DOMElements.originalWordContextContainer.classList.remove('hidden');

                        DOMElements.synonymsList.innerHTML = formatWords(synonyms);
                        DOMElements.synonymsContainer.classList.remove('hidden');
                        
                        DOMElements.antonymsList.innerHTML = formatWords(antonyms);
                        DOMElements.antonymsContainer.classList.remove('hidden');
                    }
                },
            };
        })();
        
        /**
         * -------------------
         * GEMINI API MODULE
         * Handles calls to the Google Gemini API.
         * -------------------
         */
        const GeminiModule = (() => {
            const API_KEY = "AIzaSyCWgdZlzRHZFLL02TnfZHAEXlTvUIZE7OM"; // PASTE YOUR API KEY HERE
            const BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

            async function callApi(payload) {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                return response.json();
            }

            const parseJsonResponse = (result) => {
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) return null;
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse JSON from Gemini:", e);
                    return null;
                }
            };

            return {
                generateAndTranslateExamples: async (word) => {
                    const prompt = `For the English word "${word}", generate two distinct, slightly longer example sentences. One sentence should be formal and suitable for an academic context like the IELTS exam. The other should be informal and suitable for daily communication. For each example, also provide its Vietnamese translation.`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "ieltsExample": {
                                type: "OBJECT",
                                properties: { "english": { "type": "STRING" }, "vietnamese": { "type": "STRING" } },
                                required: ["english", "vietnamese"]
                            },
                            "communicationExample": {
                                type: "OBJECT",
                                properties: { "english": { "type": "STRING" }, "vietnamese": { "type": "STRING" } },
                                required: ["english", "vietnamese"]
                            }
                        },
                        required: ["ieltsExample", "communicationExample"]
                    };
                    const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                    const result = await callApi(payload);
                    return parseJsonResponse(result);
                },

                translateExample: async (sentence) => {
                    const prompt = `Translate the following English sentence to Vietnamese: "${sentence}"`;
                     const schema = {
                         type: "OBJECT",
                         properties: { "vietnameseExample": { "type": "STRING" } },
                         required: ["vietnameseExample"]
                    };
                    const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                    const result = await callApi(payload);
                    return parseJsonResponse(result);
                },

                findRelatedWords: async (word) => {
                    const prompt = `For the English word "${word}", first provide a brief explanation in Vietnamese about its primary context or nuance. Then, provide a list of its common synonyms and antonyms suitable for a vocabulary learner. For each synonym and antonym, also provide its Vietnamese translation and a brief explanation in Vietnamese about its specific context or nuance.`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "originalWordContext": { "type": "STRING" },
                            "synonyms": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "english": { "type": "STRING" },
                                        "vietnamese": { "type": "STRING" },
                                        "context": { "type": "STRING" }
                                    },
                                    required: ["english", "vietnamese", "context"]
                                }
                            },
                            "antonyms": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "english": { "type": "STRING" },
                                        "vietnamese": { "type": "STRING" },
                                        "context": { "type": "STRING" }
                                    },
                                    required: ["english", "vietnamese", "context"]
                                }
                            }
                        },
                        required: ["originalWordContext", "synonyms", "antonyms"]
                    };
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };
                    const result = await callApi(payload);
                    // Add the original word to the response object for easier access in the UI
                    const parsed = parseJsonResponse(result);
                    if (parsed) {
                        parsed.originalWord = word;
                    }
                    return parsed;
                },
            };
        })();

        /**
         * -------------------
         * DATA MODULE
         * Handles parsing and managing vocabulary data.
         * -------------------
         */
        const DataModule = (() => {
            let fullList = [];
            let topics = {};
            let orderedTopics = [];

            return {
                loadData: (data, onError) => {
                    if (!data || data.length === 0) {
                        onError("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ t·∫£i.");
                        return false;
                    }
                    fullList = data;
                    return true;
                },

                parseXLSX: (data, onError) => {
                    try {
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length === 0) {
                             onError('File Excel tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu ·ªü sheet ƒë·∫ßu ti√™n.');
                             return null;
                        }

                        const standardizedData = json.map(row => {
                            const wordKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'word');
                            const meaningKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'meaning');
                            const ipaKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'ipa');
                            const topicKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'topic');
                            const exampleKey = Object.keys(row).find(k => k.trim().toLowerCase() === 'example');

                            if (!wordKey || !meaningKey || !row[wordKey] || !row[meaningKey]) return null;

                            return {
                                Word: String(row[wordKey] || '').trim(),
                                Meaning: String(row[meaningKey] || '').trim(),
                                Example: (exampleKey && row[exampleKey]) ? String(row[exampleKey]).trim() : '',
                                Topic: (topicKey && row[topicKey]) ? String(row[topicKey]).trim() : 'Ch∆∞a ph√¢n lo·∫°i',
                                IPA: (ipaKey && row[ipaKey]) ? String(row[ipaKey]).trim() : ''
                            };
                        }).filter(Boolean);

                        if (standardizedData.length === 0) {
                            onError('File Excel ph·∫£i c√≥ c·ªôt "Word" v√† "Meaning" v√† c√°c c·ªôt n√†y ph·∫£i c√≥ d·ªØ li·ªáu.');
                            return null;
                        }
                        return standardizedData;
                    } catch (e) {
                        console.error("Error parsing XLSX file:", e);
                        onError("Kh√¥ng th·ªÉ ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.");
                        return null;
                    }
                },
                
                getFullList: () => fullList,

                groupTopics: () => {
                    orderedTopics = [];
                    topics = fullList.reduce((acc, word) => {
                        const topic = word.Topic;
                        if (!acc[topic]) {
                            acc[topic] = [];
                            orderedTopics.push(topic);
                        }
                        acc[topic].push(word);
                        return acc;
                    }, {});
                    return { topics, orderedTopics };
                },

                getTopics: () => topics,
            };
        })();

        /**
         * -------------------
         * STORAGE MODULE
         * Handles saving and loading data from localStorage.
         * -------------------
         */
        const StorageModule = (() => {
            const FULL_LIST_KEY = 'vocabApp_fullList';
            const MODES = ['vi-en', 'en-vi', 'speak'];
            const DATA_KEYS = ['incorrectWords', 'masteredWords', 'sessionProgress'];

            const getKey = (baseKey, gameMode) => `vocabApp_${gameMode}_${baseKey}`;

            return {
                saveFullList: (list) => {
                    try {
                        localStorage.setItem(FULL_LIST_KEY, JSON.stringify(list));
                    } catch (e) { console.error("Error saving to localStorage:", e); }
                },
                loadFullList: () => {
                    try {
                        const list = localStorage.getItem(FULL_LIST_KEY);
                        return list ? JSON.parse(list) : null;
                    } catch (e) { console.error("Error loading from localStorage:", e); return null; }
                },
                saveIncorrectWords: (wordsSet, gameMode) => {
                    try {
                        localStorage.setItem(getKey('incorrectWords', gameMode), JSON.stringify(Array.from(wordsSet)));
                    } catch (e) { console.error("Error saving to localStorage:", e); }
                },
                loadIncorrectWords: (gameMode) => {
                    try {
                        const arr = localStorage.getItem(getKey('incorrectWords', gameMode));
                        return arr ? new Set(JSON.parse(arr)) : new Set();
                    } catch (e) { console.error("Error loading from localStorage:", e); return new Set(); }
                },
                saveMasteredWords: (wordsSet, gameMode) => {
                    try {
                        localStorage.setItem(getKey('masteredWords', gameMode), JSON.stringify(Array.from(wordsSet)));
                    } catch (e) { console.error("Error saving to localStorage:", e); }
                },
                loadMasteredWords: (gameMode) => {
                    try {
                        const arr = localStorage.getItem(getKey('masteredWords', gameMode));
                        return arr ? new Set(JSON.parse(arr)) : new Set();
                    } catch (e) { console.error("Error loading from localStorage:", e); return new Set(); }
                },
                saveSessionProgress: (progress, gameMode) => { 
                     try {
                        const serializable = {};
                        for (const key in progress) {
                            serializable[key] = {
                                learned: Array.from(progress[key].learned),
                                incorrect: Array.from(progress[key].incorrect),
                            };
                        }
                        localStorage.setItem(getKey('sessionProgress', gameMode), JSON.stringify(serializable));
                    } catch (e) { console.error("Error saving to localStorage:", e); }
                },
                loadSessionProgress: (gameMode) => {
                    try {
                        const data = localStorage.getItem(getKey('sessionProgress', gameMode));
                        if (!data) return {};
                        const parsed = JSON.parse(data);
                        const deserialized = {};
                         for (const key in parsed) {
                            deserialized[key] = {
                                learned: new Set(parsed[key].learned),
                                incorrect: new Set(parsed[key].incorrect),
                            };
                        }
                        return deserialized;
                    } catch (e) { console.error("Error loading from localStorage:", e); return {}; }
                },
                clearAllData: () => {
                    localStorage.removeItem(FULL_LIST_KEY);
                    MODES.forEach(mode => {
                        DATA_KEYS.forEach(key => {
                            localStorage.removeItem(getKey(key, mode));
                        });
                    });
                }
            };
        })();


        /**
         * -------------------
         * SPEECH MODULE
         * Uses the browser's native SpeechSynthesis API with a smarter voice selection.
         * -------------------
         */
        const SpeechModule = (() => {
            const synth = window.speechSynthesis;
            let voices = [];
            const utterances = []; // Prevent garbage collection

            function populateVoiceList() {
                if (typeof synth === 'undefined') {
                    console.error("Browser does not support SpeechSynthesis.");
                    return;
                }
                voices = synth.getVoices();
            }

            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
            populateVoiceList();

            return {
                speak: (text, lang = 'en-US') => {
                    if (synth.speaking) {
                        synth.cancel(); 
                    }
                    
                    if (text) {
                        const utterThis = new SpeechSynthesisUtterance(text);
                        
                        utterThis.onend = () => {
                            const index = utterances.indexOf(utterThis);
                            if (index > -1) {
                                utterances.splice(index, 1);
                            }
                        };
                        
                        utterThis.onerror = (event) => {
                            console.error('SpeechSynthesisUtterance.onerror', event);
                            const index = utterances.indexOf(utterThis);
                            if (index > -1) {
                                utterances.splice(index, 1);
                            }
                        };
                        
                        if (voices.length === 0) {
                           populateVoiceList();
                        }

                        let selectedVoice;
                        if (lang.startsWith('vi')) {
                           selectedVoice = voices.find(voice => voice.lang === 'vi-VN');
                           utterThis.rate = 0.9;
                           utterThis.pitch = 1;
                        } else { 
                           selectedVoice = voices.find(voice => voice.lang === 'en-US' && /female/i.test(voice.name));
                           if (!selectedVoice) selectedVoice = voices.find(voice => voice.name === 'Google US English');
                           if (!selectedVoice) selectedVoice = voices.find(voice => voice.lang === 'en-US');
                           if (!selectedVoice) selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
                           
                           utterThis.rate = 0.8; 
                           utterThis.pitch = 1; 
                        }

                        utterThis.voice = selectedVoice;
                        utterThis.lang = lang;
                        utterances.push(utterThis); // Keep a reference to prevent garbage collection
                        synth.speak(utterThis);
                    }
                },
                stop: () => {
                    if (synth.speaking) {
                        synth.cancel();
                    }
                }
            };
        })();

        /**
         * -------------------
         * APP CONTROLLER
         * The main controller that orchestrates the app.
         * -------------------
         */
        const App = ((UI, Data, Speech, Gemini, Storage) => {
            const DOM = UI.getDOMElements();
            let state = {
                currentWord: null,
                gameMode: 'vi-en', // Default mode
                currentTopicName: '',
                currentPackIndex: -1,
                isReviewSession: false,
                readyForNext: false,
                recognition: null,
                PACK_SIZE: 10,
                
                // Progress data - will be loaded based on gameMode
                incorrectWords: new Set(),
                masteredWords: new Set(),
                allSessionProgress: {}, 

                // Temporary states for the current session
                sessionVocabularyList: [],
                remainingWords: [],
                learnedInSession: new Set(),
                incorrectInSession: new Set(),
            };
            
            const normalizeStrict = (str) => {
                if (typeof str !== 'string') return '';
                return str.normalize('NFC').trim().toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=_`~()?'"]/g, "")
                    .replace(/\s+/g, ' '); 
            };
            
            const setupEventListeners = () => {
                DOM.fileInput.addEventListener('change', handleFileSelect);
                DOM.downloadSampleBtn.addEventListener('click', downloadSampleFile);
                
                // Mode Selection Buttons
                [DOM.selectModeViEnBtn, DOM.selectModeEnViBtn, DOM.selectModeSpeakBtn].forEach(btn => {
                    btn.addEventListener('click', () => handleModeSelection(btn.dataset.mode));
                });
                DOM.backToUploadBtnFromMode.addEventListener('click', () => {
                     Speech.stop();
                     Storage.clearAllData();
                     location.reload();
                });
                
                // Back Buttons
                DOM.backToModeSelectionBtn.addEventListener('click', () => {
                    Speech.stop();
                    UI.showScreen('mode-selection-section');
                });
                DOM.backToTopicSelectionBtn.addEventListener('click', () => {
                    Speech.stop();
                    renderTopicView();
                });

                // In-App Buttons
                DOM.checkBtn.addEventListener('click', checkAnswer);
                DOM.nextBtn.addEventListener('click', () => { if (state.readyForNext) getNewWord(); });
                DOM.answerInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (state.readyForNext) getNewWord();
                        else if (!DOM.checkBtn.disabled) checkAnswer();
                    }
                });

                document.addEventListener('keydown', e => {
                    if (e.code === 'Space' && state.readyForNext) {
                        e.preventDefault();
                        getNewWord();
                    }
                });
                
                DOM.clearDataBtn.addEventListener('click', () => {
                    UI.showModal({
                        title: 'X√°c nh·∫≠n X√≥a',
                        message: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u v√† b·∫Øt ƒë·∫ßu l·∫°i kh√¥ng? Thao t√°c n√†y s·∫Ω x√≥a ti·∫øn ƒë·ªô c·ªßa T·∫§T C·∫¢ c√°c ch·∫ø ƒë·ªô.',
                        onConfirm: () => {
                            Storage.clearAllData();
                            location.reload();
                        }
                    })
                });

                // Speech
                DOM.mainSpeakerBtn.addEventListener('click', () => { if (state.currentWord) Speech.speak(state.currentWord.Word, 'en-US'); });
                DOM.answerSpeakerBtn.addEventListener('click', () => { if (state.currentWord) Speech.speak(state.currentWord.Word, 'en-US'); });
                DOM.ieltsExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.ieltsExampleSentence.textContent.replace('üá¨üáß ', ''), 'en-US'));
                DOM.commExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.commExampleSentence.textContent.replace('ÔøΩüáß ', ''), 'en-US'));
                DOM.singleExampleSpeakerBtn.addEventListener('click', () => Speech.speak(DOM.exampleSentence.textContent.replace('üá¨üáß ', ''), 'en-US'));

                DOM.speakBtn.addEventListener('click', () => {
                    if (state.recognition) {
                        try {
                           DOM.speakBtn.classList.add('mic-listening', 'text-red-500');
                           state.recognition.start();
                        } catch(e) {
                              console.error("Error starting recognition: ", e);
                              DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');
                        }
                    }
                });

                // Gemini
                DOM.generateExampleBtn.addEventListener('click', handleGenerateNewExample);
                DOM.findRelatedBtn.addEventListener('click', handleFindRelatedWords);

                // Related Words Speaker
                DOM.relatedWordsContent.addEventListener('click', (e) => {
                    const speakerBtn = e.target.closest('.related-speaker-btn');
                    if (speakerBtn) {
                        const wordToSpeak = speakerBtn.dataset.word;
                        if (wordToSpeak) {
                            Speech.speak(wordToSpeak, 'en-US');
                        }
                    }
                });
            };

            const handleModeSelection = (mode) => {
                Speech.stop();
                state.gameMode = mode;
                
                // Load progress specific to the selected mode
                state.incorrectWords = Storage.loadIncorrectWords(state.gameMode);
                state.masteredWords = Storage.loadMasteredWords(state.gameMode);
                state.allSessionProgress = Storage.loadSessionProgress(state.gameMode);
                
                renderTopicView();
            };

            // --- AI Feature Handlers ---
            async function fetchAndShowExamples(wordData, forceNew = false) {
                 try {
                    if (wordData.Example && !forceNew) {
                        const result = await Gemini.translateExample(wordData.Example);
                        if(result && result.vietnameseExample) {
                             UI.displayExamples({ single: { english: wordData.Example, vietnamese: result.vietnameseExample } });
                        } else {
                            throw new Error("Translation failed.");
                        }
                    } else {
                        const result = await Gemini.generateAndTranslateExamples(wordData.Word);
                        if(result && result.ieltsExample && result.communicationExample){
                             UI.displayExamples({ 
                                 ielts: { english: result.ieltsExample.english, vietnamese: result.ieltsExample.vietnamese },
                                 communication: { english: result.communicationExample.english, vietnamese: result.communicationExample.vietnamese }
                             });
                        } else {
                            throw new Error("Generation failed.");
                        }
                    }
                } catch (error) {
                    console.error("Failed to fetch examples:", error);
                    UI.displayExamples({ error: 'Kh√¥ng th·ªÉ t·∫£i v√≠ d·ª•. Vui l√≤ng th·ª≠ l·∫°i.' });
                }
            }
            
            const handleGenerateNewExample = async () => {
                if (!state.currentWord) return;
                
                UI.setNewExampleLoading(true);
                await fetchAndShowExamples(state.currentWord, true);
                UI.setNewExampleLoading(false);
            };

            const handleFindRelatedWords = async () => {
                if (!state.currentWord) return;

                UI.setRelatedWordsLoading(true);

                try {
                    const result = await Gemini.findRelatedWords(state.currentWord.Word);
                    if (result) {
                        UI.displayRelatedWords(result);
                    } else {
                        throw new Error("Kh√¥ng th·ªÉ t√¨m th·∫•y t·ª´ li√™n quan.");
                    }
                } catch (error) {
                    console.error("Failed to fetch related words:", error);
                    UI.displayRelatedWords({ error: 'L·ªói khi t√¨m t·ª´ li√™n quan. Vui l√≤ng th·ª≠ l·∫°i.' });
                } finally {
                    UI.setRelatedWordsLoading(false);
                }
            };
            
            // --- Core App Logic ---
            const downloadSampleFile = () => {
                const sampleData = [
                  { Word: 'diligent', Meaning: 'si√™ng nƒÉng, c·∫ßn c√π', Topic: 'Adjectives (T√≠nh t·ª´)', IPA: '/Ààd…™l.…ô.d í…ônt/', Example: 'His diligent efforts were rewarded with a promotion.' },
                  { Word: 'ubiquitous', Meaning: 'ph·ªï bi·∫øn, ·ªü ƒë√¢u c≈©ng c√≥', Topic: 'Adjectives (T√≠nh t·ª´)', IPA: '/juÀêÀàb…™k.w…ô.tÃ¨…ôs/', Example: 'The company\'s logo has become ubiquitous all over the world.' },
                  { Word: 'co-working space', Meaning: 'kh√¥ng gian l√†m vi·ªác chung', Topic: 'Business (Kinh doanh)', IPA: '/Àåko äÀàw…úÀêrk…™≈ã spe…™s/', Example: 'Many freelancers prefer the collaborative environment of a co-working space.' },
                  { Word: 'mitigate', Meaning: 'gi·∫£m nh·∫π, l√†m d·ªãu b·ªõt', Topic: 'Verbs (ƒê·ªông t·ª´)', IPA: '/Ààm…™tÃ¨.…ô.…°e…™t/', Example: 'They are trying to mitigate the effects of the recession.' },
                  { Word: 'eloquent', Meaning: 'h√πng h·ªìn, c√≥ t√†i h√πng bi·ªán', Topic: 'Adjectives (T√≠nh t·ª´)', IPA: '/Ààel.…ô.kw…ônt/', Example: 'She gave an eloquent speech at the conference.'}
                ];
                const worksheet = XLSX.utils.json_to_sheet(sampleData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "T·ª´ v·ª±ng m·∫´u");
                XLSX.writeFile(workbook, "TuVung_Mau.xlsx");
            };

            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                DOM.fileNameDisplay.textContent = `ƒêang t·∫£i file: ${file.name}`;
                DOM.uploadError.textContent = '';
                if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                    DOM.uploadError.textContent = 'Vui l√≤ng ch·ªâ ch·ªçn file c√≥ ƒë·ªãnh d·∫°ng .xlsx ho·∫∑c .xls';
                    DOM.fileNameDisplay.textContent = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    const parsedData = Data.parseXLSX(data, (msg) => { DOM.uploadError.textContent = msg; });
                    if(Data.loadData(parsedData, (msg) => { DOM.uploadError.textContent = msg; })) {
                         Storage.clearAllData();
                         Storage.saveFullList(parsedData);
                         UI.showScreen('mode-selection-section');
                    } else {
                         DOM.fileNameDisplay.textContent = '';
                    }
                };
                reader.onerror = () => { DOM.uploadError.textContent = 'ƒê√£ c√≥ l·ªói x·∫£y ra khi ƒë·ªçc file.'; };
                reader.readAsArrayBuffer(file);
            };

            const updateAndRenderStats = () => {
                const sessionTotal = state.sessionVocabularyList.length;
                const sessionCorrect = state.learnedInSession.size;
                const sessionIncorrect = state.incorrectInSession.size;
                const sessionRemaining = sessionTotal - (sessionCorrect + sessionIncorrect);
                
                let topicMastered = 0;
                let topicTotal = 0;
                let showTopicStats = false;
                
                const allTopics = Data.getTopics();
                if (state.currentTopicName && allTopics[state.currentTopicName] && !state.isReviewSession && state.currentTopicName !== 'T·∫•t c·∫£') {
                    const topicWords = allTopics[state.currentTopicName];
                    topicTotal = topicWords.length;
                    topicMastered = topicWords.filter(w => state.masteredWords.has(w.Word)).length;
                    showTopicStats = true;
                }

                UI.renderStats({
                    sessionCorrect,
                    sessionIncorrect,
                    sessionRemaining,
                    sessionTotal,
                    topicMastered,
                    topicTotal,
                    showTopicStats,
                    sessionPercentage: sessionTotal > 0 ? ((sessionCorrect + sessionIncorrect) / sessionTotal) * 100 : 0
                });
            };
            
            const renderTopicView = () => {
                UI.resetUIState();
                DOM.specialSelectionListContainer.innerHTML = '';
                DOM.selectionListContainer.innerHTML = '';
                
                // Note: state.incorrectWords is now specific to the current gameMode
                if (state.incorrectWords.size > 0) {
                    const reviewBtn = document.createElement('button');
                    reviewBtn.className = 'w-full text-left bg-orange-500 text-white font-semibold p-4 rounded-lg hover:bg-orange-600 topic-button flex flex-col';
                    reviewBtn.innerHTML = `
                        <div>
                            <span>√în t·∫≠p l·∫°i t·ª´ sai</span>
                            <span class="font-normal text-sm">(${state.incorrectWords.size} t·ª´)</span>
                        </div>
                    `;
                    reviewBtn.onclick = () => {
                        Speech.stop();
                        const reviewList = Data.getFullList().filter(word => state.incorrectWords.has(word.Word));
                        state.isReviewSession = true;
                        startGame(reviewList, '√în t·∫≠p');
                    };
                    DOM.specialSelectionListContainer.appendChild(reviewBtn);
                }

                const { topics, orderedTopics } = Data.groupTopics();
                
                if (Object.keys(topics).length > 1) {
                    const allBtn = document.createElement('button');
                    const allWords = Data.getFullList();
                    const allMastered = allWords.filter(w => state.masteredWords.has(w.Word)).length;
                    const allTotal = allWords.length;
                    const allPercentage = allTotal > 0 ? (allMastered / allTotal) * 100 : 0;
                    const isAllCompleted = allMastered === allTotal && allTotal > 0;

                    allBtn.className = `w-full text-left font-semibold p-4 rounded-lg topic-button flex flex-col ${isAllCompleted ? 'bg-teal-500 text-white hover:bg-teal-600' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`;
                    allBtn.innerHTML = `
                        <div>
                            <span>H·ªçc t·∫•t c·∫£</span>
                            <span class="font-normal text-sm">(${allMastered}/${allTotal} t·ª´)</span>
                        </div>
                        <div class="w-full ${isAllCompleted ? 'bg-teal-400' : 'bg-indigo-400'} rounded-full h-1.5 mt-2">
                            <div class="bg-white h-1.5 rounded-full" style="width: ${allPercentage}%"></div>
                        </div>
                    `;
                    allBtn.onclick = () => {
                        Speech.stop();
                        startGame(Data.getFullList(), 'T·∫•t c·∫£');
                    };
                    DOM.specialSelectionListContainer.appendChild(allBtn);
                }
                
                orderedTopics.forEach(topicName => {
                    const btn = document.createElement('button');
                    const topicWords = topics[topicName];
                    const totalCount = topicWords.length;
                    const masteredCount = topicWords.filter(w => state.masteredWords.has(w.Word)).length;
                    const percentage = totalCount > 0 ? (masteredCount / totalCount) * 100 : 0;
                    const isTopicCompleted = masteredCount === totalCount && totalCount > 0;

                    let textColor = isTopicCompleted ? 'text-teal-800' : 'text-slate-800';
                    let subTextColor = isTopicCompleted ? 'text-teal-600' : 'text-slate-500';
                    
                    let englishName = topicName;
                    let vietnameseName = '';
                    const match = topicName.match(/(.*)\((.*)\)/);
                    if (match && match[1] && match[2]) {
                        englishName = match[1].trim();
                        vietnameseName = `(${match[2].trim()})`;
                    }

                    btn.className = `topic-button border bg-white border-slate-200 p-4 rounded-lg flex flex-col justify-between text-left h-32`;
                    btn.innerHTML = `
                        <div class="h-12">
                            <span class="font-semibold text-sm w-full block truncate" title="${englishName}">${englishName}</span>
                            ${vietnameseName ? `<span class="text-xs w-full block truncate ${subTextColor}" title="${vietnameseName}">${vietnameseName}</span>` : ''}
                        </div>
                        <div class="mt-auto pt-2">
                            <div class="flex justify-between items-center text-xs ${subTextColor}">
                                <span>${masteredCount}/${totalCount} t·ª´</span>
                                <span class="font-medium">${Math.round(percentage)}%</span>
                            </div>
                             <div class="w-full bg-slate-200 rounded-full h-2 mt-1">
                                <div class="progress-bar ${isTopicCompleted ? 'bg-teal-500' : 'bg-indigo-500'} h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    btn.onclick = () => {
                        Speech.stop();
                        if (topicWords.length > state.PACK_SIZE) {
                            const firstPack = topicWords.slice(0, state.PACK_SIZE);
                            startGame(firstPack, topicName, 0);
                        } else {
                            startGame(topicWords, topicName);
                        }
                    };
                    DOM.selectionListContainer.appendChild(btn);
                    
                    // Trigger animation
                    requestAnimationFrame(() => {
                        const bar = btn.querySelector('.progress-bar > div');
                        if (bar) {
                            bar.style.width = `${percentage}%`;
                        }
                    });
                });
                UI.showScreen('topic-section');
            };
            
            const setupPackSelector = (topicName, activePackIndex) => {
                const topicWords = Data.getTopics()[topicName];
                const clickHandler = (newIndex) => {
                    Speech.stop();
                    const start = newIndex * state.PACK_SIZE;
                    const newPackWords = topicWords.slice(start, start + state.PACK_SIZE);
                    startGame(newPackWords, state.currentTopicName, newIndex);
                };

                if (!topicWords || topicWords.length <= state.PACK_SIZE) {
                    UI.renderPackButtons([], activePackIndex, clickHandler);
                    return;
                }
                
                const numPacks = Math.ceil(topicWords.length / state.PACK_SIZE);
                const packsData = [];
                for (let i = 0; i < numPacks; i++) {
                    const packWords = topicWords.slice(i * state.PACK_SIZE, (i * state.PACK_SIZE) + state.PACK_SIZE);
                    const isCompleted = packWords.every(w => state.masteredWords.has(w.Word));
                    const sessionKey = `${topicName}_pack${i}`;
                    const session = state.allSessionProgress[sessionKey];
                    const isInProgress = session && (session.learned.size > 0 || session.incorrect.size > 0) && !isCompleted;
                    packsData.push({ index: i, isCompleted, isInProgress });
                }

                UI.renderPackButtons(packsData, activePackIndex, clickHandler);
            };

            const startGame = (wordList, topicName = '', packIndex = -1) => {
                Speech.stop();
                const sessionKey = packIndex > -1 ? `${topicName}_pack${packIndex}` : topicName;
                
                state.isReviewSession = (topicName === '√în t·∫≠p');
                state.currentTopicName = topicName;
                state.currentPackIndex = packIndex;
                state.sessionVocabularyList = [...wordList];
                
                if(state.isReviewSession) {
                    state.learnedInSession = new Set();
                    state.incorrectInSession = new Set();
                } else {
                    const savedSession = state.allSessionProgress[sessionKey];
                    if (savedSession) {
                        const allWordsInListMastered = wordList.every(w => state.masteredWords.has(w.Word));
                        if(allWordsInListMastered){
                             savedSession.learned.clear();
                             savedSession.incorrect.clear();
                        }
                        state.learnedInSession = savedSession.learned;
                        state.incorrectInSession = savedSession.incorrect;
                    } else {
                        state.learnedInSession = new Set();
                        state.incorrectInSession = new Set();
                        state.allSessionProgress[sessionKey] = {
                            learned: state.learnedInSession,
                            incorrect: state.incorrectInSession,
                        };
                    }
                }
                
                const modeMap = { 'vi-en': 'Vi·ªát ‚Üí Anh', 'en-vi': 'Anh ‚Üí Vi·ªát', 'speak': 'Luy·ªán N√≥i' };
                DOM.appTitle.innerHTML = `<span class="text-base text-slate-500 font-medium">${modeMap[state.gameMode]}</span><br>${state.currentTopicName}`;
                
                if (packIndex > -1) {
                    setupPackSelector(state.currentTopicName, state.currentPackIndex);
                } else {
                    DOM.packSelectorContainer.classList.add('hidden');
                }
                
                getNewWord();
                UI.showScreen('app-container');
            };
            
            const getNewWord = () => {
                Speech.stop();
                state.readyForNext = false;
                 
                state.remainingWords = state.sessionVocabularyList.filter(word => 
                    !state.learnedInSession.has(word.Word) && !state.incorrectInSession.has(word.Word)
                );

                if (state.remainingWords.length === 0) {
                    // Check if there are any words in the incorrect list for this session
                    const incorrectList = state.sessionVocabularyList.filter(word => state.incorrectInSession.has(word.Word));
                    if (incorrectList.length > 0) {
                        // If so, start a review round with only the incorrect words
                        state.remainingWords = incorrectList;
                        state.incorrectInSession.clear(); // Clear the set for the new round
                    } else {
                        // If not, the session is truly complete
                        if(state.currentPackIndex > -1) setupPackSelector(state.currentTopicName, state.currentPackIndex);
                        
                        const topicWords = Data.getTopics()[state.currentTopicName];
                        const nextPackIndex = state.currentPackIndex + 1;
                        const nextPackStart = nextPackIndex * state.PACK_SIZE;

                        if (!state.isReviewSession && state.currentPackIndex > -1 && topicWords && nextPackStart < topicWords.length) {
                            UI.showCompletionScreen("Tuy·ªát v·ªùi!", `T·ª± ƒë·ªông chuy·ªÉn sang g√≥i ${nextPackIndex + 1}...`);
                            const nextPackWords = topicWords.slice(nextPackStart, nextPackStart + state.PACK_SIZE);
                            setTimeout(() => startGame(nextPackWords, state.currentTopicName, nextPackIndex), 2500);
                        } else {
                            const message = state.isReviewSession ? 'B·∫°n ƒë√£ √¥n t·∫≠p xong.' : `B·∫°n ƒë√£ ho√†n th√†nh ch·ªß ƒë·ªÅ "${state.currentTopicName}".`
                            UI.showCompletionScreen("Ho√†n th√†nh!", message);
                            setTimeout(renderTopicView, 3000);
                        }
                        return;
                    }
                }

                const randomIndex = Math.floor(Math.random() * state.remainingWords.length);
                state.currentWord = state.remainingWords[randomIndex];
                UI.updateCard(state.currentWord, state.gameMode, state.currentPackIndex, state.currentTopicName);
                UI.resetUIState();
                updateAndRenderStats();
            };
            
            const checkAnswer = () => {
                if (!state.currentWord || DOM.checkBtn.disabled) return;
                
                const userAnswerRaw = DOM.answerInput.value;
                if (userAnswerRaw.trim() === '') return;

                let isCorrect = false;

                const correctAnswerField = (state.gameMode === 'en-vi') 
                    ? state.currentWord.Meaning 
                    : state.currentWord.Word;

                const possibleAnswers = correctAnswerField.split(';').flatMap(part => part.split(',')).map(s => s.trim());
                
                const normalizedUserAnswer = normalizeStrict(userAnswerRaw);

                for (const answer of possibleAnswers) {
                    if (!answer) continue;

                    const strictAnswer = normalizeStrict(answer);
                    // Strict comparison first
                    if (normalizedUserAnswer === strictAnswer) {
                        isCorrect = true;
                        break;
                    }
                    
                    // If strict fails AND the correct answer has a hyphen, check flexible variations
                    if (answer.includes('-')) {
                        const flexibleWithSpace = normalizeStrict(answer.replace(/-/g, ' '));
                        const flexibleWithoutSpace = normalizeStrict(answer.replace(/-/g, ''));
                        
                        if (normalizedUserAnswer === flexibleWithSpace || normalizedUserAnswer === flexibleWithoutSpace) {
                            isCorrect = true;
                            break;
                        }
                    }
                }
                
                if (isCorrect) handleCorrectAnswer();
                else handleIncorrectAnswer();
            };
            
            const handleCorrectAnswer = () => {
                DOM.inputContainer.classList.add('feedback-correct');
                DOM.feedbackIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>`;
                DOM.answerInput.disabled = true;
                DOM.checkBtn.disabled = true;
                state.readyForNext = true;

                // Update session state
                state.learnedInSession.add(state.currentWord.Word);
                state.incorrectInSession.delete(state.currentWord.Word);
                
                // Update global mastery state
                state.masteredWords.add(state.currentWord.Word);
                state.incorrectWords.delete(state.currentWord.Word);

                // --- Synchronization Logic ---
                if (state.isReviewSession) {
                    const answeredWord = state.currentWord.Word;
                    for (const sessionKey in state.allSessionProgress) {
                        const session = state.allSessionProgress[sessionKey];
                        if (session.incorrect.has(answeredWord)) {
                            session.incorrect.delete(answeredWord);
                            session.learned.add(answeredWord);
                        }
                    }
                }

                // Save all progress for the current mode
                Storage.saveMasteredWords(state.masteredWords, state.gameMode);
                Storage.saveIncorrectWords(state.incorrectWords, state.gameMode);
                Storage.saveSessionProgress(state.allSessionProgress, state.gameMode);
                
                UI.showAnswerFeedback(true, state.currentWord);
                fetchAndShowExamples(state.currentWord);
                updateAndRenderStats();
            };

            const handleIncorrectAnswer = () => {
                DOM.inputContainer.classList.add('feedback-incorrect');
                DOM.feedbackIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>`;
                
                // Update session state
                state.incorrectInSession.add(state.currentWord.Word);
                
                // Update global mastery state
                state.masteredWords.delete(state.currentWord.Word);
                state.incorrectWords.add(state.currentWord.Word);
                
                // Save all progress for the current mode
                Storage.saveMasteredWords(state.masteredWords, state.gameMode);
                Storage.saveIncorrectWords(state.incorrectWords, state.gameMode);
                Storage.saveSessionProgress(state.allSessionProgress, state.gameMode);

                DOM.checkBtn.disabled = true;
                DOM.answerInput.disabled = true;
                state.readyForNext = true;
                
                UI.showAnswerFeedback(false, state.currentWord);
                fetchAndShowExamples(state.currentWord);
                updateAndRenderStats();
            };

            const initSpeechRecognition = () => {
                 const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                  if (SpeechRecognition) {
                       state.recognition = new SpeechRecognition();
                       state.recognition.continuous = false;
                       state.recognition.lang = 'en-US';
                       state.recognition.interimResults = false;
                       state.recognition.maxAlternatives = 1;

                       state.recognition.onresult = (event) => {
                           const speechResult = event.results[0][0].transcript;
                           DOM.answerInput.value = speechResult;
                           if (state.gameMode === 'speak') checkAnswer();
                       };

                       state.recognition.onend = () => DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');

                       state.recognition.onerror = (event) => {
                           console.error("Speech recognition error", event.error);
                           let title = "L·ªói Nh·∫≠n d·∫°ng Gi·ªçng n√≥i";
                           let message = `ƒê√£ x·∫£y ra m·ªôt l·ªói: ${event.error}. Vui l√≤ng th·ª≠ l·∫°i.`;

                           if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                               title = "L·ªói Quy·ªÅn Truy C·∫≠p Micro";
                               message = "ƒê·ªÉ t√≠nh nƒÉng nh·∫≠n d·∫°ng gi·ªçng n√≥i ho·∫°t ƒë·ªông, tr√¨nh duy·ªát c·∫ßn ƒë∆∞·ª£c T·∫¢I L·∫†I TRANG sau khi b·∫°n c·∫•p quy·ªÅn. Vui l√≤ng nh·∫•n n√∫t T·∫£i l·∫°i (Reload) tr√™n tr√¨nh duy·ªát ho·∫∑c ph√≠m F5, sau ƒë√≥ ch·ªçn l·∫°i ch·∫ø ƒë·ªô Luy·ªán n√≥i.";
                           } else if (event.error === 'no-speech') {
                               title = "Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c";
                               message = "Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c gi·ªçng n√≥i. Vui l√≤ng ƒë·∫£m b·∫£o micro ho·∫°t ƒë·ªông v√† b·∫°n ƒëang n√≥i r√µ r√†ng.";
                           } else if (event.error === 'audio-capture') {
                               title = "L·ªói Micro";
                               message = "Kh√¥ng th·ªÉ thu √¢m thanh. Vui l√≤ng ki·ªÉm tra l·∫°i micro c·ªßa b·∫°n c√≥ ƒë∆∞·ª£c k·∫øt n·ªëi v√† ho·∫°t ƒë·ªông ƒë√∫ng c√°ch kh√¥ng.";
                           }
                           
                           UI.showModal({title: title, message: message});
                           DOM.speakBtn.classList.remove('mic-listening', 'text-red-500');
                       };
                       
                       DOM.selectModeSpeakBtn.classList.remove('hidden');
                   } else {
                       DOM.selectModeSpeakBtn.style.display = 'none';
                   }
            }

            return {
                init: () => {
                    document.addEventListener('DOMContentLoaded', () => {
                         setupEventListeners();
                         initSpeechRecognition();
                         const savedList = Storage.loadFullList();
                         if(savedList) {
                             Data.loadData(savedList, (err) => console.error(err));
                             UI.showScreen('mode-selection-section');
                         } else {
                             UI.showScreen('upload-section');
                         }
                    });
                }
            };
        })(UIModule, DataModule, SpeechModule, GeminiModule, StorageModule);

        App.init();
    </script>
</body>
</html>
ÔøΩ
